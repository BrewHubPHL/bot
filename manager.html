<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrewHub | Payroll</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="public/css/brand-system.css">
    <style>
        body { font-family: var(--font-body); background: var(--bg-main); color: var(--brand-primary); padding: 20px; }
        h1, h2 { font-family: var(--font-heading); color: var(--brand-primary); }
        .btn, button { background: var(--brand-accent); color: white; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 1000px; margin: auto; border: 1px solid var(--border-soft); }
        h2 { border-bottom: 2px solid var(--brand-secondary); padding-bottom: 10px; display: flex; justify-content: space-between; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: var(--brand-primary); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid var(--border-soft); }
        .pill { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; color: white; }
        .btn-back { text-decoration: none; color: var(--brand-primary); font-weight: bold; font-size: 13px; }
    </style>
</head>
<body>

    <div class="card">
        <a href="index.html" class="btn-back">‚Üê Back to Hub</a>
        <h2>
            Payroll Tally
            <span id="grand-total" style="color: #28a745;">$0.00</span>
        </h2>
        
        <div id="loader">Processing logs...</div>
        
        <table id="payroll-table" style="display:none;">
            <thead>
                <tr>
                    <th>Staff</th>
                    <th>Rate</th>
                    <th>Hours</th>
                    <th>Earned</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="payroll-list"></tbody>
        </table>
    </div>

    <script>
        const supabaseClient = window.supabase.createClient(
            'https://rruionkpgswvncypweiv.supabase.co', 
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydWlvbmtwZ3N3dm5jeXB3ZWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMTQ5MDYsImV4cCI6MjA4NDg5MDkwNn0.fzM310q9Qs_f-zhuBqyjnQXs3mDmOp_dbiFRs0ctQmU',
            { auth: { persistSession: true } }
        );

        async function calculatePayroll() {
            const list = document.getElementById('payroll-list');
            let grandTotal = 0;

            try {
                const [pRes, lRes] = await Promise.all([
                    supabaseClient.from('employee_profiles').select('*'),
                    supabaseClient.from('time_logs').select('*').order('created_at', { ascending: true })
                ]);

                document.getElementById('loader').style.display = 'none';
                document.getElementById('payroll-table').style.display = 'table';
                list.innerHTML = "";

                pRes.data.forEach(emp => {
                    let totalHours = 0;
                    const logs = lRes.data.filter(l => l.employee_email === emp.email);
                    
                    // Calculation Logic: Pairing INs with OUTs
                    let startTime = null;
                    logs.forEach(log => {
                        const type = log.action_type?.toLowerCase();
                        if (type === 'in') {
                            startTime = new Date(log.clock_in || log.created_at);
                        } else if (type === 'out' && startTime) {
                            const endTime = new Date(log.clock_out || log.created_at);
                            totalHours += (endTime - startTime) / 3600000;
                            startTime = null; // Reset pair
                        }
                    });

                    const earned = totalHours * (emp.pay_rate || 0);
                    grandTotal += earned;

                    const lastLog = logs[logs.length - 1];
                    const status = lastLog?.action_type?.toUpperCase() || 'OFF';
                    const color = status === 'IN' ? '#28a745' : '#dc3545';

                    list.innerHTML += `
                        <tr>
                            <td><strong>${emp.full_name || 'Staff'}</strong></td>
                            <td>$${(emp.pay_rate || 0).toFixed(2)}</td>
                            <td>${totalHours.toFixed(2)}</td>
                            <td style="color: #28a745; font-weight: bold;">$${earned.toFixed(2)}</td>
                            <td><span class="pill" style="background:${color}">${status}</span></td>
                        </tr>
                    `;
                });

                document.getElementById('grand-total').innerText = `Total: $${grandTotal.toFixed(2)}`;

            } catch (e) { console.error(e); }
        }

        calculatePayroll();
    </script>
</body>
</html>