<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrewHub Resident Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --brand: #d2b48c; --dark: #2c1810; --bg: #fdfbf7; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--dark); max-width: 600px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1, h2 { color: var(--dark); }
        button { background: var(--dark); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; }
        button:hover { opacity: 0.9; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .badge { background: #e0f2f1; color: #00695c; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .hidden { display: none; }
        .voucher { border: 2px dashed var(--brand); padding: 10px; text-align: center; margin-top: 10px; background: #fff8e1; }
    </style>
</head>
<body>

    <div id="login-view">
        <h1>‚òïÔ∏è Resident Portal</h1>
        
        <div id="login-form">
            <p>Already registered? Log in below.</p>
            <input type="email" id="email" placeholder="Email" />
            <input type="password" id="password" placeholder="Password" />
            <button onclick="handleLogin()">Log In</button>
            <p id="login-msg" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
            <p style="margin-top:15px; text-align:center;">
                <a href="javascript:void(0)" onclick="handleForgotPassword()" style="color:#666; font-size:0.85rem;">Forgot password?</a>
            </p>
            <p style="margin-top:10px; text-align:center;">
                <a href="#" onclick="showRegister(event); return false;" style="color:var(--dark);">New resident? <strong>Register here</strong></a>
            </p>
        </div>

        <div id="register-form" class="hidden">
            <p>Register for package tracking & coffee rewards.</p>
            <input type="text" id="reg-name" placeholder="Full Name *" required />
            <input type="text" id="reg-address" placeholder="Unit # or Address *" required />
            <input type="email" id="reg-email" placeholder="Email *" required />
            <input type="tel" id="reg-phone" placeholder="Phone (optional - for text alerts)" />
            <label style="display:flex; align-items:center; gap:8px; margin-bottom:15px; font-size:0.9rem;">
                <input type="checkbox" id="reg-sms-opt-in" /> Text me when my packages arrive
            </label>
            <button onclick="handleRegister()">Register</button>
            <p id="register-msg" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
            <p style="margin-top:20px; text-align:center;">
                <a href="#" onclick="showLogin(event); return false;" style="color:var(--dark);">Already registered? <strong>Log in</strong></a>
            </p>
        </div>

        <div id="set-password-form" class="hidden">
            <h2>üîê Set Your Password</h2>
            <p>Create a password to complete your registration.</p>
            <input type="password" id="new-password" placeholder="Create password (min 6 characters)" />
            <input type="password" id="confirm-password" placeholder="Confirm password" />
            <button onclick="handleSetPassword()">Set Password</button>
            <p id="set-password-msg" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
        </div>
    </div>

    <div id="dashboard-view" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 id="welcome-text">Welcome Home</h1>
            <button onclick="handleLogout()" style="width: auto; background: #ccc; font-size: 0.8rem;">Sign Out</button>
        </div>

        <div class="card">
            <h2>üì¶ Incoming Parcels</h2>
            <div id="parcel-list">Loading packages...</div>
        </div>

        <div class="card">
            <h2>‚òïÔ∏è Coffee Loyalty</h2>
            <div id="loyalty-progress">Checking points...</div>
            <div id="voucher-list" style="margin-top:15px;"></div>
        </div>
    </div>

    <script>
        // 1. SETUP SUPABASE
        const SUPABASE_URL = 'https://rruionkpgswvncypweiv.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydWlvbmtwZ3N3dm5jeXB3ZWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzNjU3MjMsImV4cCI6MjA2Mzk0MTcyM30.WAPtNjLOI-kIwHoKrFuejT3P6NqaVMXMrjGqFvJzSxQ';
        const supabase = toSupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function toSupabaseClient(url, key) {
            return window.supabase.createClient(url, key);
        }

        // 2. CHECK SESSION ON LOAD
        async function init() {
            // Check URL for magic link token (user just clicked email link)
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const type = hashParams.get('type');
            
            // Listen for auth changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    // Check if user needs to set password (came from magic link)
                    if (type === 'magiclink' || type === 'signup' || type === 'recovery') {
                        showPasswordSetup(session.user);
                    } else {
                        showDashboard(session.user);
                    }
                }
            });
            
            // Check existing session
            const { data: { session } } = await supabase.auth.getSession();
            if (session && !accessToken) {
                // User already logged in with password
                showDashboard(session.user);
            }
        }
        init();

        function showPasswordSetup(user) {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('set-password-form').classList.remove('hidden');
        }

        // 3. LOGIN/REGISTER TOGGLE
        function showRegister(e) {
            if (e) e.preventDefault();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            return false;
        }
        function showLogin(e) {
            if (e) e.preventDefault();
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            return false;
        }

        // 4. LOGIN LOGIC (Password)
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');
            
            if (!email || !password) {
                msg.innerText = "Please enter email and password.";
                return;
            }
            
            msg.innerText = "Logging in...";
            
            const { data, error } = await supabase.auth.signInWithPassword({ 
                email,
                password
            });
            
            if (error) {
                msg.innerText = "Error: " + error.message;
            } else {
                showDashboard(data.user);
            }
        }

        async function handleForgotPassword() {
            const email = document.getElementById('email').value;
            const msg = document.getElementById('login-msg');
            
            if (!email) {
                msg.innerText = "Enter your email first, then click Forgot password.";
                return;
            }
            
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + '/portal.html'
            });
            
            if (error) msg.innerText = "Error: " + error.message;
            else msg.innerText = "‚úÖ Check your email for reset link!";
        }

        // 5. SET PASSWORD (after magic link click)
        async function handleSetPassword() {
            const password = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-password').value;
            const msg = document.getElementById('set-password-msg');
            
            if (!password || password.length < 6) {
                msg.innerText = "Password must be at least 6 characters.";
                return;
            }
            
            if (password !== confirm) {
                msg.innerText = "Passwords don't match.";
                return;
            }
            
            msg.innerText = "Setting password...";
            
            const { data, error } = await supabase.auth.updateUser({ password });
            
            if (error) {
                msg.innerText = "Error: " + error.message;
            } else {
                // Clear URL hash and show dashboard
                window.history.replaceState(null, '', window.location.pathname);
                showDashboard(data.user);
            }
        }

        // 6. REGISTER LOGIC
        async function handleRegister() {
            const name = document.getElementById('reg-name').value.trim();
            const address = document.getElementById('reg-address').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const phone = document.getElementById('reg-phone').value.trim() || null;
            const smsOptIn = document.getElementById('reg-sms-opt-in').checked;
            const msg = document.getElementById('register-msg');

            if (!name || !address || !email) {
                msg.innerText = "Please fill in all required fields.";
                return;
            }

            msg.innerText = "Registering...";

            // Create auth user (sends magic link)
            const { error: authError } = await supabase.auth.signInWithOtp({
                email,
                options: { emailRedirectTo: window.location.origin + '/portal.html' }
            });

            if (authError) {
                msg.innerText = "Error: " + authError.message;
                return;
            }

            // Add to customers table (upsert in case they exist)
            const { error: dbError } = await supabase
                .from('customers')
                .upsert({ 
                    email,
                    name,
                    address,
                    phone,
                    sms_opt_in: smsOptIn,
                    loyalty_points: 0
                }, { onConflict: 'email' });

            if (dbError) {
                console.error("DB error:", dbError);
                msg.innerText = "‚úÖ Check your email! (Note: profile may need staff verification)";
            } else {
                msg.innerText = "‚úÖ Registered! Check your email for the login link.";
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        // 7. LOAD USER DATA
        async function showDashboard(user) {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('set-password-form').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('welcome-text').innerText = `Welcome, ${user.email.split('@')[0]}`;

            loadPackages(user.email);
            loadLoyalty(user.email);
            loadVouchers(user.id);
        }

        // Fetch loyalty points from customers table
        async function loadLoyalty(email) {
            const { data, error } = await supabase
                .from('customers')
                .select('loyalty_points')
                .eq('email', email)
                .single();

            const container = document.getElementById('loyalty-progress');
            const points = data?.loyalty_points || 0;
            const progress = points % 10;
            const freeDrinks = Math.floor(points / 10);

            container.innerHTML = `
                <div style="margin-bottom:10px;">
                    <strong>${progress}/10</strong> coffees until your next free drink
                </div>
                <div style="background:#eee; border-radius:8px; height:20px; overflow:hidden;">
                    <div style="background:var(--brand); height:100%; width:${progress * 10}%; transition: width 0.3s;"></div>
                </div>
                <p style="font-size:0.8rem; color:#666; margin-top:8px;">Total points earned: ${points}</p>
            `;
        }

        // Fetch parcels matching email (from register-tracking.js logic)
        async function loadPackages(email) {
            const { data, error } = await supabase
                .from('expected_parcels')
                .select('*')
                .eq('customer_email', email)
                .order('registered_at', { ascending: false });

            const container = document.getElementById('parcel-list');
            
            if (!data || data.length === 0) {
                container.innerHTML = "<p>No active package tracking.</p>";
                return;
            }

            container.innerHTML = data.map(p => `
                <div style="border-bottom:1px solid #eee; padding: 10px 0;">
                    <strong>${p.carrier}</strong>: ${p.tracking_number.slice(-4)}...
                    <br><span class="badge">${p.status}</span>
                </div>
            `).join('');
        }

        // Fetch active vouchers (from square-webhook.js logic)
        async function loadVouchers(userId) {
            const { data, error } = await supabase
                .from('vouchers')
                .select('*')
                .eq('user_id', userId)
                .eq('is_redeemed', false);

            const container = document.getElementById('voucher-list');

            if (!data || data.length === 0) {
                container.innerHTML = "";
                return;
            }

            container.innerHTML = "<h3 style='margin-bottom:10px;'>üéü Ready to Redeem:</h3>" + data.map(v => `
                <div class="voucher">
                    <h3>FREE COFFEE</h3>
                    <p>Code: <strong>${v.code}</strong></p>
                    <img src="${v.qr_code_base64}" style="width: 100px; height: 100px;" />
                    <p style="font-size:0.7rem;">Show this at the counter</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>