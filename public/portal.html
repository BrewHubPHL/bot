<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrewHub Resident Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/brand-system.css">
    <style>
        body { font-family: var(--font-body); background: var(--bg-main); color: var(--brand-primary); max-width: 600px; margin: 0 auto; padding: 20px; }
        h1, h2, h3 { font-family: var(--font-heading); color: var(--brand-primary); }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border-soft); }
        button, .btn { background: var(--brand-accent); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; }
        button:hover, .btn:hover { opacity: 0.9; }
        button:disabled, .btn:disabled { background: #999; cursor: not-allowed; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-soft); border-radius: 8px; box-sizing: border-box; background: white; color: var(--brand-primary); }
        .badge { background: var(--brand-secondary); color: var(--brand-primary); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .hidden { display: none; }
        .voucher { border: 2px dashed var(--brand-secondary); padding: 10px; text-align: center; margin-top: 10px; background: #fff8e1; }
    </style>
</head>
<body>

    <div id="login-view">
        <h1>‚òïÔ∏è Resident Portal</h1>
        
        <div id="login-form">
            <p>Already registered? Log in below.</p>
            <input type="email" id="email" placeholder="Email" />
            <input type="password" id="password" placeholder="Password" />
            <button id="login-btn" onclick="handleLogin()">Log In</button>
            <p id="login-msg" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
            <p style="margin-top:15px; text-align:center;">
                <a href="javascript:void(0)" onclick="handleForgotPassword()" style="color:#666; font-size:0.85rem;">Forgot password?</a>
            </p>
            <p style="margin-top:10px; text-align:center;">
                <a href="#" onclick="showRegister(event); return false;" style="color:var(--dark);">New resident? <strong>Register here</strong></a>
            </p>
        </div>

        <div id="register-form" class="hidden">
            <p>Register for package tracking & coffee rewards.</p>
            <input type="text" id="reg-name" placeholder="Full Name *" required />
            <input type="text" id="reg-address" placeholder="Unit # or Address *" required />
            <input type="email" id="reg-email" placeholder="Email *" required />
            <input type="password" id="reg-password" placeholder="Password (min 6 characters) *" required />
            <input type="password" id="reg-password-confirm" placeholder="Confirm Password *" required />
            <input type="tel" id="reg-phone" placeholder="Phone (optional - for text alerts)" />
            <label style="display:flex; align-items:center; gap:8px; margin-bottom:15px; font-size:0.9rem;">
                <input type="checkbox" id="reg-sms-opt-in" /> Text me when my packages arrive
            </label>
            <button id="register-btn" onclick="handleRegister()">Register</button>
            <p id="register-msg" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
            <p style="margin-top:20px; text-align:center;">
                <a href="#" onclick="showLogin(event); return false;" style="color:var(--dark);">Already registered? <strong>Log in</strong></a>
            </p>
        </div>

        <div id="set-password-form" class="hidden">
            <h2>üîê Reset Your Password</h2>
            <p>Create a new password for your account.</p>
            <input type="password" id="new-password" placeholder="New password (min 6 characters)" />
            <input type="password" id="confirm-password" placeholder="Confirm password" />
            <button id="set-password-btn" onclick="handleSetPassword()">Update Password</button>
            <p id="set-password-msg" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
        </div>
    </div>

    <div id="dashboard-view" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 id="welcome-text">Welcome Home</h1>
            <button onclick="handleLogout()" style="width: auto; background: #ccc; font-size: 0.8rem;">Sign Out</button>
        </div>

        <div class="card">
            <h2>üì¶ Package Lookup</h2>
            <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">Check if your package has arrived at BrewHub</p>
            <div style="display:flex; gap:8px;">
                <input type="text" id="tracking-search" placeholder="Tracking # or email" style="flex:1; margin-bottom:0;" />
                <button onclick="searchPackage()" style="width:auto; padding:12px 20px;">Check</button>
            </div>
            <div id="package-result" style="margin-top:15px;"></div>
            <div id="parcel-list" style="margin-top:15px;"></div>
        </div>

        <div class="card">
            <h2>‚òïÔ∏è Coffee Loyalty</h2>
            <div id="loyalty-progress">Checking points...</div>
            <div id="voucher-list" style="margin-top:15px;"></div>
        </div>
        
        <div class="card" style="text-align:center;">
            <h2>ü™™ Your Loyalty QR</h2>
            <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">Show this at the counter to earn points</p>
            <div id="qr-code" style="margin:15px auto;"></div>
            <p style="font-size:0.75rem; color:#999; margin-top:15px; font-style:italic;">
                Want a keychain loyalty card like you're at ShopRite in 1996?<br>
                <a href="javascript:void(0)" onclick="printKeychainCard()" style="color:var(--brand);">Print one here üìá</a>
            </p>
        </div>
    </div>

    <script>
        // 1. SETUP SUPABASE
        const SUPABASE_URL = 'https://rruionkpgswvncypweiv.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydWlvbmtwZ3N3dm5jeXB3ZWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMTQ5MDYsImV4cCI6MjA4NDg5MDkwNn0.fzM310q9Qs_f-zhuBqyjnQXs3mDmOp_dbiFRs0ctQmU';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Flag to prevent onAuthStateChange from firing during registration
        let isRegistering = false;

        // 2. CHECK SESSION ON LOAD
        async function init() {
            // Listen for auth state changes
            sb.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth event:', event, 'Session:', !!session);
                
                // Handle password recovery event specifically
                if (event === 'PASSWORD_RECOVERY') {
                    console.log('PASSWORD_RECOVERY detected - showing password form');
                    showPasswordSetup(session.user);
                    return;
                }
                
                if ((event === 'SIGNED_IN' || event === 'INITIAL_SESSION') && session) {
                    // Skip if we're in the middle of registration (handleRegister will call showDashboard)
                    if (isRegistering) return;
                    
                    // Otherwise show dashboard
                    showDashboard(session.user);
                }
            });
        }
        init();

        function showPasswordSetup(user) {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('set-password-form').classList.remove('hidden');
        }

        // 3. LOGIN/REGISTER TOGGLE
        function showRegister(e) {
            if (e) e.preventDefault();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            return false;
        }
        function showLogin(e) {
            if (e) e.preventDefault();
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            return false;
        }

        // 4. LOGIN LOGIC (Password)
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');
            const btn = document.getElementById('login-btn');
            
            if (!email || !password) {
                msg.innerText = "Please enter email and password.";
                return;
            }
            
            msg.innerText = "Logging in...";
            btn.disabled = true;
            
            const { data, error } = await sb.auth.signInWithPassword({ 
                email,
                password
            });
            
            btn.disabled = false;
            
            if (error) {
                msg.innerText = "Error: " + error.message;
            } else {
                showDashboard(data.user);
            }
        }

        async function handleForgotPassword() {
            const email = document.getElementById('email').value;
            const msg = document.getElementById('login-msg');
            
            if (!email) {
                msg.innerText = "Enter your email first, then click Forgot password.";
                return;
            }
            
            const { error } = await sb.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + '/portal.html'
            });
            
            if (error) {
                msg.innerText = "Error: " + error.message;
            } else {
                msg.innerText = "‚úÖ Check your email for reset link!";
            }
        }

        // 5. SET PASSWORD (after password reset link)
        async function handleSetPassword() {
            const password = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-password').value;
            const msg = document.getElementById('set-password-msg');
            const btn = document.getElementById('set-password-btn');
            
            if (!password || password.length < 6) {
                msg.innerText = "Password must be at least 6 characters.";
                return;
            }
            
            if (password !== confirm) {
                msg.innerText = "Passwords don't match.";
                return;
            }
            
            msg.innerText = "Setting password...";
            btn.disabled = true;
            
            const { data, error } = await sb.auth.updateUser({ password });
            
            btn.disabled = false;
            
            if (error) {
                msg.innerText = "Error: " + error.message;
                return;
            }

            if (!data.user) {
                msg.innerText = "Error: Could not update password. Please try again.";
                return;
            }

            // Clear URL hash and show dashboard
            window.history.replaceState(null, '', window.location.pathname);
            showDashboard(data.user);
        }

        // 6. REGISTER LOGIC (email + password)
        async function handleRegister() {
            const name = document.getElementById('reg-name').value.trim();
            const address = document.getElementById('reg-address').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-password-confirm').value;
            const phone = document.getElementById('reg-phone').value.trim() || null;
            const smsOptIn = document.getElementById('reg-sms-opt-in').checked;
            const msg = document.getElementById('register-msg');
            const btn = document.getElementById('register-btn');

            if (!name || !address || !email || !password) {
                msg.innerText = "Please fill in all required fields.";
                return;
            }

            if (password.length < 6) {
                msg.innerText = "Password must be at least 6 characters.";
                return;
            }

            if (password !== confirmPassword) {
                msg.innerText = "Passwords don't match.";
                return;
            }

            msg.innerText = "Registering...";
            btn.disabled = true;
            isRegistering = true;

            // Create auth user with password
            const { data, error: authError } = await sb.auth.signUp({
                email,
                password
            });

            if (authError) {
                isRegistering = false;
                btn.disabled = false;
                msg.innerText = "Error: " + authError.message;
                return;
            }

            // Check if email confirmation is required (no session returned)
            const needsEmailConfirmation = !data.session;

            // If we have a session, create customer record now
            if (data.session?.access_token) {
                const createRes = await fetch('/.netlify/functions/create-customer', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${data.session.access_token}`
                    },
                    body: JSON.stringify({
                        email,
                        name,
                        address,
                        phone,
                        sms_opt_in: smsOptIn
                    })
                });

                const createResult = await createRes.json();

                if (!createRes.ok) {
                    isRegistering = false;
                    btn.disabled = false;
                    console.error("DB error:", createResult);
                    // Don't scare user - account is created, just profile issue
                    if (needsEmailConfirmation) {
                        msg.innerHTML = `
                            <div style="background:#d4edda; padding:15px; border-radius:8px; text-align:center;">
                                <strong>üìß Check your email!</strong><br><br>
                                We sent a confirmation link to <strong>${email}</strong><br><br>
                                Click the link, then come back here to log in.
                            </div>
                        `;
                    } else {
                        msg.innerText = "Account created! Please log in.";
                    }
                    return;
                }
            } else {
                // Store pending profile until the user confirms email and logs in
                localStorage.setItem('pending_customer_profile', JSON.stringify({
                    email,
                    name,
                    address,
                    phone,
                    sms_opt_in: smsOptIn
                }));
            }

            // If email confirmation required, show clear instructions
            if (needsEmailConfirmation) {
                isRegistering = false;
                btn.disabled = false;
                msg.innerHTML = `
                    <div style="background:#d4edda; padding:15px; border-radius:8px; text-align:center;">
                        <strong>üìß Check your email!</strong><br><br>
                        We sent a confirmation link to <strong>${email}</strong><br><br>
                        Click the link, then come back here to log in.
                    </div>
                `;
                return;
            }

            // Show dashboard after customer record is created
            isRegistering = false;
            btn.disabled = false;
            showDashboard(data.user);
        }

        async function handleLogout() {
            await sb.auth.signOut();
            window.location.reload();
        }

        // 7. LOAD USER DATA
        async function showDashboard(user) {
            if (!user || !user.email) {
                console.error('showDashboard called with invalid user:', user);
                return;
            }
            
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('set-password-form').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('welcome-text').innerText = `Welcome, ${user.email.split('@')[0]}`;

            loadPackages(user.email);
            loadLoyalty(user.email);
            loadVouchers(user.id);
            generateQRCode(user.email);

            // If we have a pending profile, create it now with auth
            const pendingRaw = localStorage.getItem('pending_customer_profile');
            if (pendingRaw) {
                try {
                    const pending = JSON.parse(pendingRaw);
                    const { data: { session } } = await sb.auth.getSession();
                    if (session?.access_token) {
                        const createRes = await fetch('/.netlify/functions/create-customer', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${session.access_token}`
                            },
                            body: JSON.stringify(pending)
                        });

                        if (createRes.ok) {
                            localStorage.removeItem('pending_customer_profile');
                        }
                    }
                } catch (err) {
                    console.error('Pending profile error:', err);
                }
            }
        }
        
        // Generate QR code with email for cafe scanning
        function generateQRCode(email) {
            const container = document.getElementById('qr-code');
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(email)}`;
            container.innerHTML = `<img src="${qrUrl}" alt="Loyalty QR Code" style="border-radius:8px; border:2px solid #ddd;">`;
        }
        
        // Print keychain card like it's 1996
        async function printKeychainCard() {
            const { data: { session } } = await sb.auth.getSession();
            const email = session?.user?.email;
            if (!email) {
                alert('Please log in first!');
                return;
            }
            
            const barcodeUrl = `https://barcodeapi.org/api/128/${encodeURIComponent(email)}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(email)}`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>BrewHub Loyalty Card</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                        .card { 
                            border: 2px dashed #d2b48c; 
                            padding: 15px; 
                            width: 3.5in; 
                            margin: 20px auto;
                            border-radius: 8px;
                        }
                        .logo { font-size: 18px; font-weight: bold; color: #2c1810; margin-bottom: 10px; }
                        .barcode { margin: 10px 0; }
                        .barcode img { max-width: 100%; height: 40px; }
                        .qr { margin: 10px 0; }
                        .qr img { width: 80px; height: 80px; }
                        .tagline { font-size: 10px; color: #666; margin-top: 8px; }
                        .instructions { font-size: 11px; color: #888; margin-top: 20px; }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="card">
                        <div class="logo">‚òï BrewHub PHL</div>
                        <div class="barcode"><img src="${barcodeUrl}" alt="barcode"></div>
                        <div class="qr"><img src="${qrUrl}" alt="qr"></div>
                        <div class="tagline">Scan for points ‚Ä¢ 10 coffees = 1 FREE</div>
                    </div>
                    <div class="card">
                        <div class="logo">‚òï BrewHub PHL</div>
                        <div class="barcode"><img src="${barcodeUrl}" alt="barcode"></div>
                        <div class="qr"><img src="${qrUrl}" alt="qr"></div>
                        <div class="tagline">Scan for points ‚Ä¢ 10 coffees = 1 FREE</div>
                    </div>
                    <p class="instructions no-print">
                        ‚úÇÔ∏è Cut along the dotted line, punch a hole, attach to keychain.<br>
                        Welcome to 1996!
                    </p>
                    <button class="no-print" onclick="window.print()" style="padding:10px 20px; margin-top:10px; cursor:pointer;">
                        üñ®Ô∏è Print Cards
                    </button>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Fetch loyalty points from customers table
        async function loadLoyalty(email) {
            const container = document.getElementById('loyalty-progress');
            
            const { data, error } = await sb
                .from('customers')
                .select('loyalty_points')
                .eq('email', email)
                .single();

            if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
                console.error('Error loading loyalty:', error);
                container.innerHTML = '<p style="color:#c00;">Could not load loyalty info.</p>';
                return;
            }

            const points = data?.loyalty_points || 0;
            const beansEarned = Math.floor((points % 500) / 50); // 50 pts per purchase, 500 for free coffee
            const freeDrinks = Math.floor(points / 500);

            container.innerHTML = `
                <div style="margin-bottom:10px;">
                    <strong>${beansEarned}/10</strong> coffees until your next free drink
                </div>
                <div style="background:#eee; border-radius:8px; height:20px; overflow:hidden;">
                    <div style="background:var(--brand); height:100%; width:${beansEarned * 10}%; transition: width 0.3s;"></div>
                </div>
                <p style="font-size:0.8rem; color:#666; margin-top:8px;">Total points: ${points} | Free drinks earned: ${freeDrinks}</p>
            `;
        }

        // Fetch parcels matching email (from register-tracking.js logic)
        async function loadPackages(email) {
            const container = document.getElementById('parcel-list');
            
            const { data, error } = await sb
                .from('expected_parcels')
                .select('*')
                .eq('customer_email', email)
                .order('registered_at', { ascending: false });

            if (error) {
                console.error('Error loading packages:', error);
                container.innerHTML = '<p style="color:#c00; font-size:0.9rem;">Could not load packages.</p>';
                return;
            }
            
            if (!data || data.length === 0) {
                container.innerHTML = "";
                return;
            }

            container.innerHTML = `
                <h3 style="margin-top:15px; margin-bottom:10px; font-size:0.95rem;">üìã Your Tracked Packages:</h3>
                ${data.map(p => `
                    <div style="border-bottom:1px solid #eee; padding: 10px 0;">
                        <strong>${p.carrier || 'Unknown'}</strong>: ...${(p.tracking_number || '').slice(-6) || 'N/A'}
                        <br><span class="badge">${p.status || 'pending'}</span>
                    </div>
                `).join('')}
            `;
        }

        // Fetch active vouchers (from square-webhook.js logic)
        async function loadVouchers(userId) {
            const container = document.getElementById('voucher-list');
            
            const { data, error } = await sb
                .from('vouchers')
                .select('*')
                .eq('user_id', userId)
                .eq('is_redeemed', false);

            if (error) {
                console.error('Error loading vouchers:', error);
                container.innerHTML = '<p style="color:#c00; font-size:0.9rem;">Could not load vouchers.</p>';
                return;
            }

            if (!data || data.length === 0) {
                container.innerHTML = "";
                return;
            }

            container.innerHTML = "<h3 style='margin-bottom:10px;'>üéü Ready to Redeem:</h3>" + data.map(v => `
                <div class="voucher">
                    <h3>FREE COFFEE</h3>
                    <p>Code: <strong>${v.code || 'N/A'}</strong></p>
                    ${v.qr_code_base64 ? `<img src="${v.qr_code_base64}" style="width: 100px; height: 100px;" />` : ''}
                    <p style="font-size:0.7rem;">Show this at the counter</p>
                </div>
            `).join('');
        }

        // Search for package by tracking number (email restricted to logged-in user)
        async function searchPackage() {
            const input = document.getElementById('tracking-search').value.trim();
            const result = document.getElementById('package-result');
            
            // Get the logged-in user's email for security filtering
            const { data: { session } } = await sb.auth.getSession();
            const userEmail = session?.user?.email;
            
            if (!userEmail) {
                result.innerHTML = '<p style="color:#c00;">Please log in to search packages.</p>';
                return;
            }
            
            if (!input) {
                result.innerHTML = '<p style="color:#666;">Enter a tracking number to search.</p>';
                return;
            }

            result.innerHTML = '<p>Searching...</p>';

            // SECURITY: Parcels are looked up via expected_parcels which has the email
            // Query expected_parcels for the user's pre-registered packages
            let query = sb
                .from('expected_parcels')
                .select('*')
                .eq('customer_email', userEmail)
                .order('registered_at', { ascending: false });
            
            // If input is a tracking number, add filter
            if (!input.includes('@')) {
                query = query.ilike('tracking_number', `%${input}%`);
            }

            const { data, error } = await query.limit(10);

            if (error) {
                console.error('Search error:', error);
                result.innerHTML = `
                    <div style="background:#f8d7da; padding:15px; border-radius:8px; border:1px solid #f5c6cb;">
                        <strong>‚ùå Search failed</strong>
                        <p style="margin:5px 0 0; font-size:0.9rem;">Please try again later.</p>
                    </div>
                `;
                return;
            }

            if (!data || data.length === 0) {
                result.innerHTML = `
                    <div style="background:#fff3cd; padding:15px; border-radius:8px; border:1px solid #ffc107;">
                        <strong>üì≠ No packages found</strong>
                        <p style="margin:5px 0 0; font-size:0.9rem;">No matching packages found for your account.</p>
                    </div>
                `;
                return;
            }

            // Show results
            const formatDate = (d) => d ? new Date(d).toLocaleDateString() : 'Unknown';
            
            if (data.length === 1) {
                const p = data[0];
                const status = p.status === 'arrived' ? 'Ready for Pickup' : (p.status || 'Pending');
                const statusColor = p.status === 'arrived' ? '#28a745' : '#6c757d';
                
                result.innerHTML = `
                    <div style="background:#d4edda; padding:15px; border-radius:8px; border:1px solid #28a745;">
                        <strong style="color:${statusColor};">üì¶ ${status}</strong>
                        <p style="margin:8px 0 0; font-size:0.9rem;">
                            <strong>Carrier:</strong> ${p.carrier || 'Unknown'}<br>
                            <strong>Tracking:</strong> ...${(p.tracking_number || '').slice(-6)}<br>
                            <strong>Registered:</strong> ${formatDate(p.registered_at)}
                        </p>
                        ${p.status === 'arrived' ? '<p style="margin-top:10px; font-size:0.85rem; color:#155724;">Show ID at the counter to pick up your package.</p>' : '<p style="margin-top:10px; font-size:0.85rem; color:#666;">We\'ll notify you when it arrives.</p>'}
                    </div>
                `;
            } else {
                // Multiple packages
                result.innerHTML = `
                    <div style="background:#d4edda; padding:15px; border-radius:8px; border:1px solid #28a745;">
                        <strong>üì¶ ${data.length} Package${data.length > 1 ? 's' : ''} Tracked</strong>
                        ${data.map(p => `
                            <div style="margin-top:10px; padding:10px; background:white; border-radius:6px;">
                                <strong>${p.carrier || 'Package'}</strong> - ${p.status === 'arrived' ? 'üü¢ Ready' : '‚è≥ ' + (p.status || 'Pending')}<br>
                                <span style="font-size:0.85rem; color:#666;">...${(p.tracking_number || '').slice(-6)} | Registered: ${formatDate(p.registered_at)}</span>
                            </div>
                        `).join('')}
                        <p style="margin-top:10px; font-size:0.85rem; color:#155724;">Show ID at the counter to pick up.</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
