<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrewHub Resident Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --brand: #d2b48c; --dark: #2c1810; --bg: #fdfbf7; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--dark); max-width: 600px; margin: 0 auto; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1, h2 { color: var(--dark); }
        button { background: var(--dark); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #999; cursor: not-allowed; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .badge { background: #e0f2f1; color: #00695c; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .hidden { display: none; }
        .voucher { border: 2px dashed var(--brand); padding: 10px; text-align: center; margin-top: 10px; background: #fff8e1; }
    </style>
</head>
<body>

    <div id="login-view">
        <h1>‚òïÔ∏è Resident Portal</h1>
        
        <div id="login-form">
            <p>Already registered? Log in below.</p>
            <input type="email" id="email" placeholder="Email" />
            <input type="password" id="password" placeholder="Password" />
            <button id="login-btn" onclick="handleLogin()">Log In</button>
            <p id="login-msg" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
            <p style="margin-top:15px; text-align:center;">
                <a href="javascript:void(0)" onclick="handleForgotPassword()" style="color:#666; font-size:0.85rem;">Forgot password?</a>
            </p>
            <p style="margin-top:10px; text-align:center;">
                <a href="#" onclick="showRegister(event); return false;" style="color:var(--dark);">New resident? <strong>Register here</strong></a>
            </p>
        </div>

        <div id="register-form" class="hidden">
            <p>Register for package tracking & coffee rewards.</p>
            <input type="text" id="reg-name" placeholder="Full Name *" required />
            <input type="text" id="reg-address" placeholder="Unit # or Address *" required />
            <input type="email" id="reg-email" placeholder="Email *" required />
            <input type="password" id="reg-password" placeholder="Password (min 6 characters) *" required />
            <input type="password" id="reg-password-confirm" placeholder="Confirm Password *" required />
            <input type="tel" id="reg-phone" placeholder="Phone (optional - for text alerts)" />
            <label style="display:flex; align-items:center; gap:8px; margin-bottom:15px; font-size:0.9rem;">
                <input type="checkbox" id="reg-sms-opt-in" /> Text me when my packages arrive
            </label>
            <button id="register-btn" onclick="handleRegister()">Register</button>
            <p id="register-msg" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
            <p style="margin-top:20px; text-align:center;">
                <a href="#" onclick="showLogin(event); return false;" style="color:var(--dark);">Already registered? <strong>Log in</strong></a>
            </p>
        </div>

        <div id="set-password-form" class="hidden">
            <h2>üîê Reset Your Password</h2>
            <p>Create a new password for your account.</p>
            <input type="password" id="new-password" placeholder="New password (min 6 characters)" />
            <input type="password" id="confirm-password" placeholder="Confirm password" />
            <button id="set-password-btn" onclick="handleSetPassword()">Update Password</button>
            <p id="set-password-msg" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
        </div>
    </div>

    <div id="dashboard-view" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 id="welcome-text">Welcome Home</h1>
            <button onclick="handleLogout()" style="width: auto; background: #ccc; font-size: 0.8rem;">Sign Out</button>
        </div>

        <div class="card">
            <h2>üì¶ Package Lookup</h2>
            <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">Check if your package has arrived at BrewHub</p>
            <div style="display:flex; gap:8px;">
                <input type="text" id="tracking-search" placeholder="Tracking # or email" style="flex:1; margin-bottom:0;" />
                <button onclick="searchPackage()" style="width:auto; padding:12px 20px;">Check</button>
            </div>
            <div id="package-result" style="margin-top:15px;"></div>
            <div id="parcel-list" style="margin-top:15px;"></div>
        </div>

        <div class="card">
            <h2>‚òïÔ∏è Coffee Loyalty</h2>
            <div id="loyalty-progress">Checking points...</div>
            <div id="voucher-list" style="margin-top:15px;"></div>
        </div>
    </div>

    <script>
        // 1. SETUP SUPABASE
        const SUPABASE_URL = 'https://rruionkpgswvncypweiv.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydWlvbmtwZ3N3dm5jeXB3ZWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMTQ5MDYsImV4cCI6MjA4NDg5MDkwNn0.fzM310q9Qs_f-zhuBqyjnQXs3mDmOp_dbiFRs0ctQmU';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Flag to prevent onAuthStateChange from firing during registration
        let isRegistering = false;

        // 2. CHECK SESSION ON LOAD
        async function init() {
            // Listen for auth state changes
            sb.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth event:', event, 'Session:', !!session);
                
                // Handle password recovery event specifically
                if (event === 'PASSWORD_RECOVERY') {
                    showPasswordSetup(session.user);
                    return;
                }
                
                if ((event === 'SIGNED_IN' || event === 'INITIAL_SESSION') && session) {
                    // Skip if we're in the middle of registration (handleRegister will call showDashboard)
                    if (isRegistering) return;
                    
                    // If user explicitly requested password reset (from forgot password flow)
                    // Note: PASSWORD_RECOVERY event handles the actual reset link clicks
                    if (localStorage.getItem('pendingPasswordReset')) {
                        showPasswordSetup(session.user);
                        return;
                    }
                    
                    // Otherwise show dashboard
                    showDashboard(session.user);
                }
            });
        }
        init();

        function showPasswordSetup(user) {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('set-password-form').classList.remove('hidden');
        }

        // 3. LOGIN/REGISTER TOGGLE
        function showRegister(e) {
            if (e) e.preventDefault();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            return false;
        }
        function showLogin(e) {
            if (e) e.preventDefault();
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            return false;
        }

        // 4. LOGIN LOGIC (Password)
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');
            const btn = document.getElementById('login-btn');
            
            if (!email || !password) {
                msg.innerText = "Please enter email and password.";
                return;
            }
            
            msg.innerText = "Logging in...";
            btn.disabled = true;
            
            // Clear BEFORE login so auth listener doesn't show password form
            localStorage.removeItem('pendingPasswordReset');
            
            const { data, error } = await sb.auth.signInWithPassword({ 
                email,
                password
            });
            
            btn.disabled = false;
            
            if (error) {
                msg.innerText = "Error: " + error.message;
            } else {
                showDashboard(data.user);
            }
        }

        async function handleForgotPassword() {
            const email = document.getElementById('email').value;
            const msg = document.getElementById('login-msg');
            
            if (!email) {
                msg.innerText = "Enter your email first, then click Forgot password.";
                return;
            }
            
            // Mark that we're expecting a password reset
            localStorage.setItem('pendingPasswordReset', 'true');
            
            const { error } = await sb.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + '/portal.html'
            });
            
            if (error) {
                msg.innerText = "Error: " + error.message;
                localStorage.removeItem('pendingPasswordReset');
            } else {
                msg.innerText = "‚úÖ Check your email for reset link!";
            }
        }

        // 5. SET PASSWORD (after password reset link)
        async function handleSetPassword() {
            const password = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-password').value;
            const msg = document.getElementById('set-password-msg');
            const btn = document.getElementById('set-password-btn');
            
            if (!password || password.length < 6) {
                msg.innerText = "Password must be at least 6 characters.";
                return;
            }
            
            if (password !== confirm) {
                msg.innerText = "Passwords don't match.";
                return;
            }
            
            msg.innerText = "Setting password...";
            btn.disabled = true;
            
            const { data, error } = await sb.auth.updateUser({ password });
            
            btn.disabled = false;
            
            if (error) {
                msg.innerText = "Error: " + error.message;
                return;
            }

            if (!data.user) {
                msg.innerText = "Error: Could not update password. Please try again.";
                return;
            }

            // Clear password reset flag
            localStorage.removeItem('pendingPasswordReset');
            
            // Clear URL hash and show dashboard
            window.history.replaceState(null, '', window.location.pathname);
            showDashboard(data.user);
        }

        // 6. REGISTER LOGIC (email + password)
        async function handleRegister() {
            const name = document.getElementById('reg-name').value.trim();
            const address = document.getElementById('reg-address').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-password-confirm').value;
            const phone = document.getElementById('reg-phone').value.trim() || null;
            const smsOptIn = document.getElementById('reg-sms-opt-in').checked;
            const msg = document.getElementById('register-msg');
            const btn = document.getElementById('register-btn');

            if (!name || !address || !email || !password) {
                msg.innerText = "Please fill in all required fields.";
                return;
            }

            if (password.length < 6) {
                msg.innerText = "Password must be at least 6 characters.";
                return;
            }

            if (password !== confirmPassword) {
                msg.innerText = "Passwords don't match.";
                return;
            }

            msg.innerText = "Registering...";
            btn.disabled = true;
            isRegistering = true;

            // Create auth user with password
            const { data, error: authError } = await sb.auth.signUp({
                email,
                password,
                options: {
                    emailRedirectTo: window.location.origin + '/portal.html'
                }
            });

            if (authError) {
                isRegistering = false;
                btn.disabled = false;
                msg.innerText = "Error: " + authError.message;
                return;
            }

            // Check if email confirmation is required (no session returned)
            const needsEmailConfirmation = !data.session;

            // Create customer record in database immediately
            // (RLS allows anon insert so this works before email confirmation)
            const { error: dbError } = await sb
                .from('customers')
                .upsert({ 
                    email,
                    name,
                    address,
                    phone,
                    sms_opt_in: smsOptIn,
                    loyalty_points: 0
                }, { onConflict: 'email' });

            if (dbError) {
                isRegistering = false;
                btn.disabled = false;
                console.error("DB error:", dbError);
                // Don't scare user - account is created, just profile issue
                if (needsEmailConfirmation) {
                    msg.innerHTML = `
                        <div style="background:#d4edda; padding:15px; border-radius:8px; text-align:center;">
                            <strong>üìß Check your email!</strong><br><br>
                            We sent a confirmation link to <strong>${email}</strong><br><br>
                            Click the link, then come back here to log in.
                        </div>
                    `;
                } else {
                    msg.innerText = "Account created! Please log in.";
                }
                return;
            }

            // If email confirmation required, show clear instructions
            if (needsEmailConfirmation) {
                isRegistering = false;
                btn.disabled = false;
                msg.innerHTML = `
                    <div style="background:#d4edda; padding:15px; border-radius:8px; text-align:center;">
                        <strong>üìß Check your email!</strong><br><br>
                        We sent a confirmation link to <strong>${email}</strong><br><br>
                        Click the link, then come back here to log in.
                    </div>
                `;
                return;
            }

            // Show dashboard after customer record is created
            isRegistering = false;
            btn.disabled = false;
            showDashboard(data.user);
        }

        async function handleLogout() {
            await sb.auth.signOut();
            window.location.reload();
        }

        // 7. LOAD USER DATA
        async function showDashboard(user) {
            if (!user || !user.email) {
                console.error('showDashboard called with invalid user:', user);
                return;
            }
            
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('set-password-form').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('welcome-text').innerText = `Welcome, ${user.email.split('@')[0]}`;

            loadPackages(user.email);
            loadLoyalty(user.email);
            loadVouchers(user.id);
        }

        // Fetch loyalty points from customers table
        async function loadLoyalty(email) {
            const container = document.getElementById('loyalty-progress');
            
            const { data, error } = await sb
                .from('customers')
                .select('loyalty_points')
                .eq('email', email)
                .single();

            if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
                console.error('Error loading loyalty:', error);
                container.innerHTML = '<p style="color:#c00;">Could not load loyalty info.</p>';
                return;
            }

            const points = data?.loyalty_points || 0;
            const progress = points % 10;
            const freeDrinks = Math.floor(points / 10);

            container.innerHTML = `
                <div style="margin-bottom:10px;">
                    <strong>${progress}/10</strong> coffees until your next free drink
                </div>
                <div style="background:#eee; border-radius:8px; height:20px; overflow:hidden;">
                    <div style="background:var(--brand); height:100%; width:${progress * 10}%; transition: width 0.3s;"></div>
                </div>
                <p style="font-size:0.8rem; color:#666; margin-top:8px;">Total points earned: ${points}</p>
            `;
        }

        // Fetch parcels matching email (from register-tracking.js logic)
        async function loadPackages(email) {
            const container = document.getElementById('parcel-list');
            
            const { data, error } = await sb
                .from('expected_parcels')
                .select('*')
                .eq('customer_email', email)
                .order('registered_at', { ascending: false });

            if (error) {
                console.error('Error loading packages:', error);
                container.innerHTML = '<p style="color:#c00; font-size:0.9rem;">Could not load packages.</p>';
                return;
            }
            
            if (!data || data.length === 0) {
                container.innerHTML = "";
                return;
            }

            container.innerHTML = `
                <h3 style="margin-top:15px; margin-bottom:10px; font-size:0.95rem;">üìã Your Tracked Packages:</h3>
                ${data.map(p => `
                    <div style="border-bottom:1px solid #eee; padding: 10px 0;">
                        <strong>${p.carrier || 'Unknown'}</strong>: ...${(p.tracking_number || '').slice(-6) || 'N/A'}
                        <br><span class="badge">${p.status || 'pending'}</span>
                    </div>
                `).join('')}
            `;
        }

        // Fetch active vouchers (from square-webhook.js logic)
        async function loadVouchers(userId) {
            const container = document.getElementById('voucher-list');
            
            const { data, error } = await sb
                .from('vouchers')
                .select('*')
                .eq('user_id', userId)
                .eq('is_redeemed', false);

            if (error) {
                console.error('Error loading vouchers:', error);
                container.innerHTML = '<p style="color:#c00; font-size:0.9rem;">Could not load vouchers.</p>';
                return;
            }

            if (!data || data.length === 0) {
                container.innerHTML = "";
                return;
            }

            container.innerHTML = "<h3 style='margin-bottom:10px;'>üéü Ready to Redeem:</h3>" + data.map(v => `
                <div class="voucher">
                    <h3>FREE COFFEE</h3>
                    <p>Code: <strong>${v.code || 'N/A'}</strong></p>
                    ${v.qr_code_base64 ? `<img src="${v.qr_code_base64}" style="width: 100px; height: 100px;" />` : ''}
                    <p style="font-size:0.7rem;">Show this at the counter</p>
                </div>
            `).join('');
        }

        // Search for package by tracking number OR email
        async function searchPackage() {
            const input = document.getElementById('tracking-search').value.trim();
            const result = document.getElementById('package-result');
            
            if (!input) {
                result.innerHTML = '<p style="color:#666;">Enter a tracking number or email to search.</p>';
                return;
            }

            result.innerHTML = '<p>Searching...</p>';

            // Check if input looks like an email
            const isEmail = input.includes('@');
            let query;

            if (isEmail) {
                // Search by resident email - may return multiple packages
                query = sb
                    .from('parcels')
                    .select('*')
                    .ilike('resident_email', input)
                    .eq('picked_up', false)
                    .order('created_at', { ascending: false });
            } else {
                // Search by tracking number
                query = sb
                    .from('parcels')
                    .select('*')
                    .ilike('tracking_number', `%${input}%`)
                    .limit(5);
            }

            const { data, error } = await query;

            if (error) {
                console.error('Search error:', error);
                result.innerHTML = `
                    <div style="background:#f8d7da; padding:15px; border-radius:8px; border:1px solid #f5c6cb;">
                        <strong>‚ùå Search failed</strong>
                        <p style="margin:5px 0 0; font-size:0.9rem;">Please try again later.</p>
                    </div>
                `;
                return;
            }

            if (!data || data.length === 0) {
                result.innerHTML = `
                    <div style="background:#fff3cd; padding:15px; border-radius:8px; border:1px solid #ffc107;">
                        <strong>üì≠ No packages found</strong>
                        <p style="margin:5px 0 0; font-size:0.9rem;">${isEmail ? 'No pending packages for this email.' : "This tracking number hasn't been checked in yet."}</p>
                    </div>
                `;
                return;
            }

            // Show results
            const formatDate = (d) => d ? new Date(d).toLocaleDateString() : 'Unknown';
            
            if (data.length === 1) {
                const p = data[0];
                const status = p.picked_up ? 'Picked Up' : 'Ready for Pickup';
                const statusColor = p.picked_up ? '#6c757d' : '#28a745';
                
                result.innerHTML = `
                    <div style="background:#d4edda; padding:15px; border-radius:8px; border:1px solid #28a745;">
                        <strong style="color:${statusColor};">üì¶ ${status}</strong>
                        <p style="margin:8px 0 0; font-size:0.9rem;">
                            <strong>Carrier:</strong> ${p.carrier || 'Unknown'}<br>
                            <strong>Checked in:</strong> ${formatDate(p.created_at)}
                        </p>
                        ${!p.picked_up ? '<p style="margin-top:10px; font-size:0.85rem; color:#155724;">Show ID at the counter to pick up your package.</p>' : ''}
                    </div>
                `;
            } else {
                // Multiple packages
                result.innerHTML = `
                    <div style="background:#d4edda; padding:15px; border-radius:8px; border:1px solid #28a745;">
                        <strong>üì¶ ${data.length} Package${data.length > 1 ? 's' : ''} Found</strong>
                        ${data.map(p => `
                            <div style="margin-top:10px; padding:10px; background:white; border-radius:6px;">
                                <strong>${p.carrier || 'Package'}</strong> - ${p.picked_up ? '‚úì Picked up' : 'üü¢ Ready'}<br>
                                <span style="font-size:0.85rem; color:#666;">Checked in: ${formatDate(p.created_at)}</span>
                            </div>
                        `).join('')}
                        <p style="margin-top:10px; font-size:0.85rem; color:#155724;">Show ID at the counter to pick up.</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
