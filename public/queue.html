<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Queue | BrewHub PHL</title>
  <meta name="robots" content="noindex">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: #0a0a0a;
      color: #fff;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Header bar */
    .header {
      background: #111;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #222;
    }
    .header-logo {
      font-size: 1.8rem;
      font-weight: 900;
      color: #f39c12;
    }
    .header-logo span { color: #fff; }
    .header-info {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      color: #888;
      font-size: 0.9rem;
    }
    .header-count {
      background: #f39c12;
      color: #000;
      font-weight: 700;
      padding: 0.3rem 0.8rem;
      border-radius: 8px;
      font-size: 1rem;
    }
    .header-clock {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      color: #aaa;
    }

    /* Queue grid */
    .queue-container {
      padding: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
      max-height: calc(100vh - 80px);
      overflow-y: auto;
    }

    /* Order card */
    .order-card {
      background: #1a1a1a;
      border-radius: 16px;
      border: 2px solid #333;
      overflow: hidden;
      transition: all 0.3s ease;
      animation: slideIn 0.4s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Status-based top border */
    .order-card.pending, .order-card.unpaid {
      border-top: 6px solid #e74c3c;
    }
    .order-card.paid {
      border-top: 6px solid #27ae60;
    }
    .order-card.preparing {
      border-top: 6px solid #f39c12;
    }
    .order-card.ready {
      border-top: 6px solid #3498db;
      animation: slideIn 0.4s ease-out, readyPulse 2s infinite;
    }
    .order-card.completed {
      border-top: 6px solid #2ecc71;
      background: #0d1f12;
      animation: slideIn 0.4s ease-out, completedGlow 2.5s infinite;
    }
    .order-card.completed-unpaid {
      border-top: 6px solid #e74c3c;
      background: #1f0d0d;
      animation: slideIn 0.4s ease-out, unpaidBlink 1.5s infinite;
    }
    @keyframes readyPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
      50% { box-shadow: 0 0 20px 8px rgba(52, 152, 219, 0.2); }
    }
    @keyframes completedGlow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
      50% { box-shadow: 0 0 20px 8px rgba(46, 204, 113, 0.2); }
    }
    @keyframes unpaidBlink {
      0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.5); }
      50% { box-shadow: 0 0 24px 10px rgba(231, 76, 60, 0.3); }
    }

    /* Card header */
    .card-header {
      padding: 1rem 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 1px solid #2a2a2a;
    }
    .card-position {
      font-size: 0.75rem;
      font-weight: 700;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .card-name {
      font-size: 1.6rem;
      font-weight: 900;
      color: #fff;
      line-height: 1.1;
    }
    .card-tag {
      font-size: 0.75rem;
      font-family: monospace;
      color: #888;
      margin-top: 0.2rem;
    }

    /* Status badge */
    .status-badge {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      padding: 0.25rem 0.6rem;
      border-radius: 6px;
      white-space: nowrap;
    }
    .status-badge.pending, .status-badge.unpaid {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
    }
    .status-badge.paid {
      background: rgba(39, 174, 96, 0.2);
      color: #27ae60;
    }
    .status-badge.preparing {
      background: rgba(243, 156, 18, 0.2);
      color: #f39c12;
    }
    .status-badge.ready {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
    }
    .status-badge.completed {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
    }

    /* Payment indicator */
    .payment-warning {
      display: inline-block;
      font-size: 0.7rem;
      font-weight: 700;
      color: #e74c3c;
      animation: blink 1.5s infinite;
      margin-top: 0.25rem;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Items list */
    .card-items {
      padding: 0.8rem 1.2rem;
    }
    .card-item {
      padding: 0.3rem 0;
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
    }
    .item-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #e0e0e0;
    }
    .item-mods {
      font-size: 0.8rem;
      color: #888;
      font-style: italic;
    }

    /* Time footer */
    .card-footer {
      padding: 0.5rem 1.2rem;
      background: #111;
      font-size: 0.75rem;
      color: #666;
      display: flex;
      justify-content: space-between;
    }

    /* Ready section header */
    .section-label {
      grid-column: 1 / -1;
      font-size: 1.2rem;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 0.5rem 0;
      border-bottom: 2px solid #333;
      margin-bottom: 0.5rem;
    }
    .section-label.completed-label { color: #2ecc71; }
    .section-label.ready-label { color: #3498db; }
    .section-label.progress-label { color: #f39c12; }
    .section-label.waiting-label { color: #888; }

    /* Empty state */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 4rem 2rem;
      color: #555;
    }
    .empty-state h2 {
      font-size: 3rem;
      margin-bottom: 0.5rem;
    }
    .empty-state p {
      font-size: 1.2rem;
    }

    /* Responsive: big screens get bigger cards */
    @media (min-width: 1400px) {
      .card-name { font-size: 2rem; }
      .item-name { font-size: 1.3rem; }
      .queue-container { gap: 1.5rem; padding: 2rem; }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-logo">Brew<span>Hub</span> <span style="font-size:0.6em; color:#888; font-weight:400;">Order Queue</span></div>
    <div class="header-info">
      <span class="header-clock" id="clockDisplay"></span>
      <span class="header-count" id="countBadge">0 orders</span>
    </div>
  </header>

  <div class="queue-container" id="queueGrid">
    <div class="empty-state">
      <h2>☕</h2>
      <p>No active orders — queue is clear!</p>
    </div>
  </div>

  <script>
    // Allowlisted CSS class names to prevent class-injection via status field
    const SAFE_STATUSES = new Set(['pending', 'unpaid', 'paid', 'preparing', 'ready', 'completed']);
    function safeStatus(raw) {
      return SAFE_STATUSES.has(raw) ? raw : 'pending';
    }

    // DOM helper: create element with optional classes and text
    function el(tag, classNames, textContent) {
      const node = document.createElement(tag);
      if (classNames) classNames.split(' ').filter(Boolean).forEach(c => node.classList.add(c));
      if (textContent != null) node.textContent = textContent;
      return node;
    }

    // Clock display
    function updateClock() {
      const now = new Date();
      document.getElementById('clockDisplay').textContent = now.toLocaleTimeString('en-US', {
        hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true
      });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Status display labels
    const STATUS_LABELS = {
      pending: 'Waiting',
      unpaid: 'Collect Payment',
      paid: 'Paid',
      preparing: 'Making It',
      ready: 'Pick Up!',
      completed: 'Order Complete'
    };

    // Build a single order card using safe DOM APIs (no innerHTML)
    function buildCard(order) {
      const status = safeStatus(order.status);
      const isComplete = status === 'completed';
      const cardClass = (isComplete && !order.isPaid) ? 'completed-unpaid' : status;
      const badgeStatus = (isComplete && !order.isPaid) ? 'unpaid' : status;
      const badgeLabel = (isComplete && !order.isPaid)
        ? '\u26A0\uFE0F UNPAID'
        : (STATUS_LABELS[status] || status);

      const card = el('div', 'order-card ' + cardClass);

      // --- Card header ---
      const header = el('div', 'card-header');

      const headerLeft = document.createElement('div');
      const positionText = isComplete
        ? '\u2705 Ready \u2014 grab it!'
        : '#' + String(Number(order.position) || 0) + ' in queue';
      headerLeft.appendChild(el('div', 'card-position', positionText));
      headerLeft.appendChild(el('div', 'card-name', String(order.name || '')));
      headerLeft.appendChild(el('div', 'card-tag', String(order.tag || '')));

      if (!order.isPaid) {
        headerLeft.appendChild(el('div', 'payment-warning', '\u26A0\uFE0F COLLECT PAYMENT'));
      }

      header.appendChild(headerLeft);
      header.appendChild(el('span', 'status-badge ' + badgeStatus, badgeLabel));
      card.appendChild(header);

      // --- Items list ---
      const itemsContainer = el('div', 'card-items');
      const orderItems = Array.isArray(order.items) ? order.items : [];

      if (orderItems.length === 0) {
        const noItems = el('span', null, 'No items');
        noItems.style.color = '#555';
        itemsContainer.appendChild(noItems);
      } else {
        orderItems.forEach(function (item) {
          const row = el('div', 'card-item');
          row.appendChild(el('span', 'item-name', String(item.name || '')));
          if (item.mods) {
            row.appendChild(el('span', 'item-mods', String(item.mods)));
          }
          itemsContainer.appendChild(row);
        });
      }
      card.appendChild(itemsContainer);

      // --- Footer ---
      const footer = el('div', 'card-footer');
      footer.appendChild(el('span', null, String(Number(order.minutesAgo) || 0) + 'm ago'));
      footer.appendChild(el('span', null, orderItems.length + ' item' + (orderItems.length !== 1 ? 's' : '')));
      card.appendChild(footer);

      return card;
    }

    // Build a section label element
    function buildSectionLabel(text, modifier) {
      return el('div', 'section-label ' + modifier, text);
    }

    // Build the empty-state placeholder
    function buildEmptyState() {
      const wrapper = el('div', 'empty-state');
      wrapper.appendChild(el('h2', null, '\u2615'));
      wrapper.appendChild(el('p', null, 'No active orders \u2014 queue is clear!'));
      return wrapper;
    }

    // Fetch and render queue using safe DOM manipulation
    async function refreshQueue() {
      try {
        const res = await fetch('/.netlify/functions/get-queue');
        if (!res.ok) throw new Error('API error');
        const data = await res.json();
        const queue = Array.isArray(data.queue) ? data.queue : [];
        const count = typeof data.count === 'number' ? data.count : queue.length;

        document.getElementById('countBadge').textContent =
          count + ' order' + (count !== 1 ? 's' : '');

        const grid = document.getElementById('queueGrid');

        // Clear previous content safely
        while (grid.firstChild) grid.removeChild(grid.firstChild);

        if (count === 0) {
          grid.appendChild(buildEmptyState());
          return;
        }

        // Group by status for visual sections
        const completed  = queue.filter(function (o) { return o.status === 'completed'; });
        const ready      = queue.filter(function (o) { return o.status === 'ready'; });
        const inProgress = queue.filter(function (o) { return o.status === 'preparing'; });
        const waiting    = queue.filter(function (o) { return ['pending', 'unpaid', 'paid'].includes(o.status); });

        var sections = [
          { items: completed,  label: '\u2705 Order Complete \u2014 Pick Up!', css: 'completed-label' },
          { items: ready,      label: '\uD83D\uDD14 Ready for Pickup',         css: 'ready-label' },
          { items: inProgress, label: '\uD83D\uDD25 Now Making',               css: 'progress-label' },
          { items: waiting,    label: '\u23F3 In Queue',                        css: 'waiting-label' }
        ];

        sections.forEach(function (section) {
          if (section.items.length > 0) {
            grid.appendChild(buildSectionLabel(section.label, section.css));
            section.items.forEach(function (order) {
              grid.appendChild(buildCard(order));
            });
          }
        });

      } catch (err) {
        console.error('Queue refresh error:', err);
      }
    }

    // Initial load + auto-refresh every 10 seconds
    refreshQueue();
    setInterval(refreshQueue, 10000);
  </script>

</body>
</html>
