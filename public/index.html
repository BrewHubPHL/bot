<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BrewHub PHL | Cafe & Parcel Hub</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
                        * {
                            box-sizing: border-box;
                        }

                        @media (max-width: 500px) {
                            #chatbox {
                                position: fixed;
                                left: 5vw;  /* Gives 5% breathing room on the left */
                                right: 5vw; /* Gives 5% breathing room on the right */
                                width: 90vw;
                                bottom: 100px; /* Moves it up so it doesn't hit the home bar */
                            }
                        }
                #chat-input,
                .hub-form input {
                    font-size: 16px !important; /* Forces 16px to satisfy iOS Safari */
                    -webkit-text-size-adjust: 100%;
                }
        :root { --hub-brown: #3c2f2f; --hub-tan: #d4b59e; --hub-light: #f8f4f0; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--hub-light); margin: 0; color: var(--hub-brown); display: flex; flex-direction: column; min-height: 100vh; }
        
        header { background: var(--hub-brown); color: #fff; padding: 40px 20px; text-align: center; border-bottom: 4px solid var(--hub-tan); }
        #logo { max-width: 280px; width: 100%; height: auto; margin-bottom: 10px; }
        
        main { flex: 1; display: flex; justify-content: center; align-items: center; padding: 40px 20px; }
        .hero-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); max-width: 450px; width: 100%; text-align: center; }
        
        .hub-form { display: flex; flex-direction: column; gap: 15px; }
        .hub-form input { padding: 15px; border: 1px solid #ddd; border-radius: 12px; font-size: 1em; background: #fafafa; }
        .primary-btn { background: var(--hub-brown); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }

        /* Floating Bot UI */
        #bot-bubble { position: fixed; bottom: 30px; right: 30px; z-index: 1000; }
        #bot-trigger { width: 70px; height: 70px; background: var(--hub-brown); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        /* Pulse Animation */
        .speaking-pulse { animation: pulse-glow 1.5s infinite; filter: drop-shadow(0 0 10px var(--hub-tan)); }
        @keyframes pulse-glow { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Chatbox */
        #chatbox { display: none; position: absolute; bottom: 85px; right: 0; width: 320px; background: #fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(60,47,47,0.2); flex-direction: column; overflow: hidden; border: 1px solid var(--hub-brown); }
        #chat-header { background: var(--hub-brown); color: #fff; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; }
        #chat-messages { flex: 1; padding: 15px; background: #faf8f6; max-height: 250px; overflow-y: auto; }
        
        /* Mic Icon & Form */
        #chat-form { display: flex; align-items: center; border-top: 1px solid #eee; background: #fff; padding-right: 10px; }
        #chat-input { flex: 1; border: none; padding: 15px; outline: none; }
        #mic-btn { background: none; border: none; font-size: 1.4em; cursor: pointer; color: #ccc; transition: 0.3s; }
        #mic-btn.listening { color: #d32f2f; transform: scale(1.2); animation: mic-pulse 1.5s infinite; }
        @keyframes mic-pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #voice-toggle { cursor: pointer; font-size: 1.2em; border: none; background: none; color: white; }

        /* Voice Level Bar */
        #voice-level-bar {
            width: 60px;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin-left: 10px;
            display: inline-block;
            vertical-align: middle;
            overflow: hidden;
        }
        #voice-level-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4b59e 0%, #3c2f2f 100%);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
        }
    </style>
</head>
<body>

    <header>
        <img src="logo.png" alt="BrewHub PHL" id="logo">
        <p>Philly's Premier Coffee & Parcel Hub</p>
    </header>

    <main>
        <section class="hero-card">
            <h1>Join the Waitlist</h1>
            <p style="color: #666; margin-bottom: 25px;">Secure your spot for opening day perks and seamless parcel management.</p>
            <form class="hub-form" id="waitlist-form">
                <input type="email" id="email" placeholder="Email Address" required>
                <button type="submit" class="primary-btn">Get Early Access</button>
            </form>
            <p id="form-msg" style="display:none; color: green; margin-top: 15px;">You're on the list! See you soon.</p>
        </section>
    </main>

    <div id="bot-bubble">
        <div id="bot-trigger"><span>â˜•</span></div>
        <div id="chatbox">
            <div id="chat-header">
                <span>BrewBot</span>
                <div>
                    <button id="voice-toggle" title="Toggle Voice">ðŸ”Š</button>
                    <span id="chat-close" style="cursor:pointer; margin-left:10px;">Ã—</span>
                </div>
            </div>
            <div id="chat-messages"></div>
            <form id="chat-form">
                <input id="chat-input" type="text" placeholder="Ask BrewBot..." autocomplete="off" required />
                <button type="button" id="mic-btn">ðŸŽ¤</button>
                <span id="voice-level-bar"><span id="voice-level-fill"></span></span>
                <button type="submit" style="background:var(--hub-brown); color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">Send</button>
            </form>
        </div>
    </div>

    <script>
        const botTrigger = document.getElementById('bot-trigger');
        const chatbox = document.getElementById('chatbox');
        const chatInput = document.getElementById('chat-input');
        const chatForm = document.getElementById('chat-form');
        const micBtn = document.getElementById('mic-btn');
        const voiceToggle = document.getElementById('voice-toggle');
        const voiceLevelFill = document.getElementById('voice-level-fill');

        let isMuted = false;
        let recognition = null;
        let recognizing = false;
        let chatHistory = [{ role: 'system', content: "You are BrewBot, the AI Barista at BrewHub PHL. Be concise and Philly-friendly." }];

        // --- SpeechRecognition Setup ---
        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (window.SpeechRecognition) {
            recognition = new window.SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.continuous = false;

            recognition.onstart = () => {
                recognizing = true;
                micBtn.classList.add('listening');
                startVoiceLevel();
            };
            recognition.onend = () => {
                recognizing = false;
                micBtn.classList.remove('listening');
                stopVoiceLevel();
            };
            recognition.onerror = (e) => {
                recognizing = false;
                micBtn.classList.remove('listening');
                stopVoiceLevel();
            };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim();
                if (transcript) {
                    chatInput.value = transcript;
                    chatForm.requestSubmit();
                }
            };
        } else {
            micBtn.style.display = 'none';
            document.getElementById('voice-level-bar').style.display = 'none';
        }

        micBtn.addEventListener('click', () => {
            if (!recognition) return;
            if (recognizing) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        // --- 1. VOICE RECOGNITION (LISTENING) + LEVEL ---
        let audioStream, audioContext, analyser, dataArray, rafId;

        async function startVoiceLevel() {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(audioStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                source.connect(analyser);
                animateVoiceLevel();
            } catch (err) {
                // Fallback: hide bar if not allowed
                voiceLevelFill.style.width = '0%';
            }
        }

        function animateVoiceLevel() {
            analyser.getByteTimeDomainData(dataArray);
            // Calculate normalized volume (0-1)
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                const v = (dataArray[i] - 128) / 128;
                sum += v * v;
            }
            const volume = Math.sqrt(sum / dataArray.length);
            const percent = Math.min(1, volume * 3) * 100;
            voiceLevelFill.style.width = percent + '%';
            rafId = requestAnimationFrame(animateVoiceLevel);
        }

        function stopVoiceLevel() {
            if (rafId) cancelAnimationFrame(rafId);
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            voiceLevelFill.style.width = '0%';
        }

        // --- 2. TEXT-TO-SPEECH (SPEAKING) ---
        async function speakReply(text) {
            if (isMuted) return;
            botTrigger.classList.add('speaking-pulse');
            try {
                const res = await fetch('/.netlify/functions/elevenlabs-tts', {
                    method: 'POST',
                    body: JSON.stringify({ text })
                });
                const base64 = await res.text();
                const audio = new Audio(`data:audio/mpeg;base64,${base64}`);
                await audio.play();
                audio.onended = () => {
                    botTrigger.classList.remove('speaking-pulse');
                    // Only restart recognition if not muted, chatbox is open, and not already recognizing
                    if (!isMuted && recognition && chatbox.style.display === 'flex' && !recognizing) {
                        try { recognition.start(); } catch (e) {}
                    }
                };
            } catch (err) { botTrigger.classList.remove('speaking-pulse'); }
        }

        // --- 3. CHAT FLOW ---
        voiceToggle.onclick = (e) => { e.stopPropagation(); isMuted = !isMuted; voiceToggle.innerText = isMuted ? 'ðŸ”‡' : 'ðŸ”Š'; };
        
        botTrigger.onclick = () => {
            if (chatbox.style.display === 'flex') { chatbox.style.display = 'none'; return; }
            chatbox.style.display = 'flex';
            const greet = "Hey! Welcome to the Hub. How can I help you today?";
            renderMsg('assistant', greet);
            speakReply(greet);
        };

        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const msg = chatInput.value;
            chatHistory.push({ role: 'user', content: msg });
            renderMsg('user', msg);
            chatInput.value = '';

            const res = await fetch('/.netlify/functions/grok-proxy', { method: 'POST', body: JSON.stringify({ messages: chatHistory }) });
            const data = await res.json();
            const reply = data.choices[0].message.content;
            chatHistory.push({ role: 'assistant', content: reply });
            renderMsg('assistant', reply);
            speakReply(reply);
        };

        function renderMsg(role, text) {
            const div = document.createElement('div');
            div.innerHTML = `<strong>${role === 'user' ? 'You' : 'BrewBot'}:</strong> ${text}`;
            div.style.marginBottom = "10px";
            document.getElementById('chat-messages').appendChild(div);
            document.getElementById('chat-messages').scrollTop = 9999;
        }
        
        document.getElementById('chat-close').onclick = () => chatbox.style.display = 'none';

        // --- 4. VOICE LEVEL VISUALIZATION ---
        // Remove old updateVoiceLevel/recognition event code (now handled above)
    </script>
</body>
</html>