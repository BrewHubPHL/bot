<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrewHub Cafe | Order Coffee & Drinks | Point Breeze PHL</title>
  <meta name="description" content="Order coffee, espresso, and drinks at BrewHub Cafe in Point Breeze, Philadelphia. Fast pickup for locals in 19146.">
  <link rel="canonical" href="https://brewhubphl.com/cafe.html">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://brewhubphl.com/cafe.html">
  <meta property="og:title" content="BrewHub Cafe | Order Coffee & Drinks">
  <meta property="og:description" content="Order coffee, espresso, and drinks at BrewHub Cafe in Point Breeze, Philadelphia.">
  <meta property="og:image" content="https://brewhubphl.com/logo.png">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3"></script>
  <script src="/js/auth.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh; color: #fff;
    }
    .header { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); padding: 1rem 2rem; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { font-size: 1.5rem; font-weight: 700; color: #f39c12; }
    .logo span { color: #fff; }
    .nav-links a { color: rgba(255,255,255,0.7); text-decoration: none; margin-left: 2rem; font-size: 0.9rem; transition: color 0.2s; }
    .nav-links a:hover, .nav-links a.active { color: #f39c12; }
    .container { display: grid; grid-template-columns: 1fr 350px; gap: 2rem; padding: 2rem; max-width: 1400px; margin: 0 auto; }
    .order-card { background: rgba(255,255,255,0.08); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 1rem; }
    .status-paid { background: #27ae60; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
    .card { background: rgba(255,255,255,0.08); border-radius: 16px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 1rem; }
    .checkout-btn { width: 100%; background: #27ae60; color: #fff; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
    .checkout-btn:disabled { opacity: 0.3; }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link" style="position:absolute;top:-40px;left:0;background:#000;color:#fff;padding:8px;z-index:100;transition:top 0.3s;" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Skip to main content</a>
  <header class="header">
    <div class="logo">Brew<span>Hub</span></div>
    <nav class="nav-links">
      <a href="staff-hub.html">Staff Hub</a>
      <a href="cafe.html" class="active">Cafe POS</a>
      <a href="parcels.html">Parcel Hub</a>
      <a href="scan.html">Inventory</a>
      <a href="manager.html">Dashboard</a>
    </nav>
  </header>
  
  <main class="container">
    <section>
      <h2>ðŸ“‹ Menu</h2>
      <div id="menuGrid" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
        <span style="color: rgba(255,255,255,0.5); font-size: 0.9rem;">Loading menu...</span>
      </div>
      <h2 style="margin-top:1.5rem;">ðŸ“‹ Live Orders</h2>
      <div id="ordersFeed"></div>
    </section>
    
    <aside>
      <div class="card">
        <h3>ðŸ›’ Current Order</h3>
        <div id="cartItems" style="margin: 15px 0;"></div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span id="cartTotal" style="font-size: 1.5rem; color: #f39c12; font-weight: bold;">$0.00</span>
            <button class="checkout-btn" id="checkoutBtn" onclick="checkout()" disabled style="width: auto; padding: 10px 20px;">Pay â†’</button>
        </div>
      </div>
    </aside>
  </main>

  <script>
    // XSS Protection
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // 1. GLOBAL STATE (No redeclaring 'supabase')
    let cart = [];

    // 2. POS FUNCTIONS (Available immediately)
    function addToCart(item) {
      // Merge into existing cart entry or add new
      const existing = cart.find(c => c.product_id === item.product_id);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({ product_id: item.product_id, name: item.name, display_price: item.display_price, quantity: 1 });
      }
      renderCart();
    }

    function renderCart() {
      const list = document.getElementById('cartItems');
      list.innerHTML = cart.map(item => `<div>${escapeHtml(item.name)} x${item.quantity} - $${(item.display_price * item.quantity).toFixed(2)}</div>`).join('');
      const total = cart.reduce((s, i) => s + i.display_price * i.quantity, 0);
      document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
      document.getElementById('checkoutBtn').disabled = cart.length === 0;
    }

    async function checkout() {
  const client = window.brewAuth.client;
  const btn = document.getElementById('checkoutBtn');
  
  try {
    btn.disabled = true;
    btn.textContent = 'Processingâ€¦';

    // Get the session for Authorization header
    const { data: { session } } = await client.auth.getSession();
    if (!session) {
      alert('Session expired. Please log in again.');
      window.location.href = '/login.html';
      return;
    }

    // 15-second timeout via AbortController
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 15000);

    // Call server-side checkout API (validates prices server-side)
    let response;
    try {
      response = await fetch('/.netlify/functions/cafe-checkout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${session.access_token}`,
          'X-BrewHub-Action': 'true'
        },
        body: JSON.stringify({ items: cart.map(i => ({ product_id: i.product_id, quantity: i.quantity })) }),
        signal: controller.signal
      });
    } catch (fetchErr) {
      if (fetchErr.name === 'AbortError') {
        throw new Error('Request timed out. Please check your connection and try again.');
      }
      // TypeError: Failed to fetch â€” network drop
      throw new Error('Network disconnected. Please check your connection and try again.');
    } finally {
      clearTimeout(timeout);
    }

    const result = await response.json();

    if (!response.ok) {
      throw new Error(result.error || 'Checkout failed');
    }

    alert('Order Success!');
    cart = [];
    renderCart();
  } catch (err) {
    console.error(err);
    alert('Checkout Failed: ' + err.message);
  } finally {
    btn.disabled = cart.length === 0;
    btn.textContent = 'Pay â†’';
  }
}

    // 3. INITIALIZATION & REALTIME
    async function init() {
      // Wait for brewAuth to exist
      while (!window.brewAuth) {
        await new Promise(r => setTimeout(r, 100));
      }
      
      // Staff auth required
      await window.brewAuth.protectPage({ requiredRole: 'staff' });
      
      const client = window.brewAuth.client;
      console.log("âœ… Cafe POS Connected");

      // Load menu from merch_products (same source as Next.js POS)
      const { data: menuData, error: menuErr } = await client
        .from('merch_products')
        .select('id, name, price_cents')
        .eq('is_active', true)
        .order('sort_order', { ascending: true })
        .order('name', { ascending: true });

      const grid = document.getElementById('menuGrid');
      if (!menuErr && menuData && menuData.length > 0) {
        grid.innerHTML = menuData.map(item => {
          const priceDollars = (item.price_cents / 100).toFixed(2);
          return `<button onclick="addToCart({product_id:'${item.id}',name:'${escapeHtml(item.name).replace(/'/g, "\\'")},display_price:${priceDollars}})" style="padding:10px 14px;border-radius:8px;border:none;background:#3498db;color:white;cursor:pointer;font-size:0.85rem;white-space:nowrap;">+ ${escapeHtml(item.name)} $${priceDollars}</button>`;
        }).join('');
      } else {
        grid.innerHTML = '<span style="color:#e74c3c;">Could not load menu</span>';
      }
      
      // Load recent orders for the feed
      const { data } = await client.from('orders').select('*').order('created_at', { ascending: false }).limit(5);
      if (data) data.forEach(addOrderToFeed);

      // Subscribe to new orders
      client.channel('orders-cafe').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, payload => {
        addOrderToFeed(payload.new);
      }).subscribe();
    }

    function addOrderToFeed(order) {
      const feed = document.getElementById('ordersFeed');
      if (!feed) return;
      feed.innerHTML = `<div class="order-card">Order #${escapeHtml(order.id.slice(0,5))} <span class="status-paid">${escapeHtml(order.status)}</span></div>` + feed.innerHTML;
    }

    init();
  </script>
</body>
</html>