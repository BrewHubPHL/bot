<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Staff Hub | BrewHub</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3"></script>
  <script src="/js/auth.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh; 
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
    }
    .header { 
      background: rgba(0,0,0,0.3);
      padding: 1rem 2rem; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .logo { font-size: 1.5rem; font-weight: 700; }
    .logo span { color: #f39c12; }
    .user-info { display: flex; align-items: center; gap: 1rem; }
    .user-name { font-size: 0.9rem; color: #ccc; }
    .logout-btn { 
      background: #e74c3c; 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem; 
      border-radius: 8px; 
      cursor: pointer;
      font-weight: 600;
    }
    .logout-btn:hover { background: #c0392b; }
    
    .container { 
      flex: 1;
      display: flex; 
      flex-direction: column;
      align-items: center; 
      justify-content: center;
      padding: 2rem;
      gap: 2rem;
    }
    
    /* Clock Section */
    .clock-section {
      text-align: center;
      margin-bottom: 1rem;
    }
    .current-time {
      font-size: 4rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .current-date {
      font-size: 1.2rem;
      color: #888;
      margin-top: 0.5rem;
    }
    
    /* Status Card */
    .status-card {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 2.5rem;
      width: 100%;
      max-width: 400px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .status-label {
      font-size: 0.9rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.5rem;
    }
    .status-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
    }
    .status-value.clocked-in { color: #27ae60; }
    .status-value.clocked-out { color: #e74c3c; }
    
    .clock-btn {
      width: 100%;
      padding: 1.2rem 2rem;
      font-size: 1.2rem;
      font-weight: 700;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .clock-btn.clock-in {
      background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
      color: white;
      box-shadow: 0 8px 24px rgba(39, 174, 96, 0.4);
    }
    .clock-btn.clock-in:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(39, 174, 96, 0.5);
    }
    .clock-btn.clock-out {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      box-shadow: 0 8px 24px rgba(231, 76, 60, 0.4);
    }
    .clock-btn.clock-out:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(231, 76, 60, 0.5);
    }
    .clock-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .shift-info {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 0.9rem;
      color: #888;
    }
    .shift-time {
      font-size: 1.5rem;
      font-weight: 600;
      color: #f39c12;
      margin-top: 0.5rem;
    }
    
    /* Quick Links */
    .quick-links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      width: 100%;
      max-width: 600px;
    }
    .quick-link {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 1.5rem 1rem;
      text-align: center;
      text-decoration: none;
      color: #fff;
      transition: all 0.2s;
    }
    .quick-link:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-4px);
      border-color: #f39c12;
    }
    .quick-link .icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .quick-link .label {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .quick-link.manager-only {
      border-color: #f39c12;
      background: rgba(243, 156, 18, 0.15);
    }
    .quick-link.manager-only .label {
      color: #f39c12;
    }
    
    /* Message */
    .message {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    .message.success { background: rgba(39, 174, 96, 0.2); color: #27ae60; }
    .message.error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
    
    @media (max-width: 600px) {
      .current-time { font-size: 3rem; }
      .status-card { padding: 1.5rem; }
      .quick-links { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">Brew<span>Hub</span> Staff</div>
    <div class="user-info">
      <span class="user-name" id="userName">Loading...</span>
      <button class="logout-btn" onclick="window.brewAuth.signOut()">Logout</button>
    </div>
  </header>

  <main class="container">
    <div class="clock-section">
      <div class="current-time" id="currentTime">--:--:--</div>
      <div class="current-date" id="currentDate">Loading...</div>
    </div>
    
    <div class="status-card">
      <div class="status-label">Your Status</div>
      <div class="status-value" id="statusValue">Loading...</div>
      
      <button class="clock-btn clock-in" id="clockBtn" onclick="toggleClock()" disabled>
        Loading...
      </button>
      
      <div class="message" id="message" style="display: none;"></div>
      
      <div class="shift-info" id="shiftInfo" style="display: none;">
        <div>Current shift started</div>
        <div class="shift-time" id="shiftDuration">0:00:00</div>
      </div>
    </div>
    
    <div class="quick-links" id="quickLinks">
      <a href="kds.html" class="quick-link">
        <div class="icon">â˜•</div>
        <div class="label">KDS</div>
      </a>
      <a href="cafe.html" class="quick-link">
        <div class="icon">ðŸ’³</div>
        <div class="label">Cafe POS</div>
      </a>
      <a href="parcels.html" class="quick-link">
        <div class="icon">ðŸ“¦</div>
        <div class="label">Parcels</div>
      </a>
      <a href="scan.html" class="quick-link">
        <div class="icon">ðŸ“‹</div>
        <div class="label">Inventory</div>
      </a>
      <!-- Manager link added dynamically -->
    </div>
  </main>

  <script>
    let isWorking = false;
    let shiftStart = null;
    let userEmail = null;
    let shiftInterval = null;
    
    // Update clock every second
    function updateClock() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: true 
      });
      document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }
    setInterval(updateClock, 1000);
    updateClock();
    
    // Update shift duration
    function updateShiftDuration() {
      if (!shiftStart) return;
      const now = new Date();
      const diff = now - shiftStart;
      const hours = Math.floor(diff / 3600000);
      const mins = Math.floor((diff % 3600000) / 60000);
      const secs = Math.floor((diff % 60000) / 1000);
      document.getElementById('shiftDuration').textContent = 
        `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = `message ${type}`;
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', 4000);
    }
    
    function updateUI() {
      const statusEl = document.getElementById('statusValue');
      const btn = document.getElementById('clockBtn');
      const shiftInfo = document.getElementById('shiftInfo');
      
      if (isWorking) {
        statusEl.textContent = 'Clocked In';
        statusEl.className = 'status-value clocked-in';
        btn.textContent = 'ðŸ›‘ Clock Out';
        btn.className = 'clock-btn clock-out';
        shiftInfo.style.display = 'block';
        if (!shiftInterval) {
          shiftInterval = setInterval(updateShiftDuration, 1000);
        }
      } else {
        statusEl.textContent = 'Clocked Out';
        statusEl.className = 'status-value clocked-out';
        btn.textContent = 'â–¶ Clock In';
        btn.className = 'clock-btn clock-in';
        shiftInfo.style.display = 'none';
        if (shiftInterval) {
          clearInterval(shiftInterval);
          shiftInterval = null;
        }
      }
      btn.disabled = false;
    }
    
    async function toggleClock() {
      const btn = document.getElementById('clockBtn');
      btn.disabled = true;
      
      const action = isWorking ? 'out' : 'in';
      
      try {
        const session = window.brewAuth.session;
        const res = await fetch('/.netlify/functions/log-time', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
            'X-BrewHub-Action': 'true'
          },
          body: JSON.stringify({
            employee_email: userEmail,
            action_type: action
          })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.error || 'Failed to clock ' + action);
        }
        
        isWorking = !isWorking;
        if (isWorking) {
          shiftStart = new Date();
        } else {
          shiftStart = null;
        }
        
        showMessage(`Successfully clocked ${action}!`, 'success');
        updateUI();
        
      } catch (err) {
        console.error('Clock error:', err);
        showMessage(err.message || 'Failed to update status', 'error');
        btn.disabled = false;
      }
    }
    
    async function loadStatus() {
      try {
        const client = window.brewAuth.client;
        const session = window.brewAuth.session;
        
        if (!session) return;
        
        // Always query fresh status from database (don't rely on cache for is_working)
        const { data: freshStaff, error } = await client
          .from('staff_directory')
          .select('email, name, is_working')
          .ilike('email', session.user.email)
          .single();
        
        if (error || !freshStaff) {
          console.error('Could not load staff status:', error);
          return;
        }
        
        userEmail = freshStaff.email;
        isWorking = freshStaff.is_working === true;
        
        // If clocked in, estimate shift start from last clock-in log
        if (isWorking) {
          const { data: logs } = await client
            .from('time_logs')
            .select('*')
            .eq('employee_email', userEmail.toLowerCase())
            .eq('action_type', 'in')
            .order('created_at', { ascending: false })
            .limit(1);
          
          if (logs && logs.length > 0) {
            shiftStart = new Date(logs[0].clock_in || logs[0].created_at);
          } else {
            shiftStart = new Date(); // Fallback
          }
        }
        
        updateUI();
        
      } catch (err) {
        console.error('Status load error:', err);
      }
    }
    
    async function init() {
      // Wait for auth
      let attempts = 0;
      while (!window.brewAuth && attempts < 50) {
        await new Promise(r => setTimeout(r, 100));
        attempts++;
      }
      
      if (!window.brewAuth) {
        console.error("Auth system failed to load");
        return;
      }
      
      // Protect page - any staff can access
      const user = await window.brewAuth.protectPage({ requiredRole: 'staff' });
      if (!user) return;
      
      // Update UI with user info
      const staff = window.brewAuth.staff;
      document.getElementById('userName').textContent = staff?.name || user.email;
      
      // Add manager dashboard link if manager or admin
      if (staff?.role === 'manager' || staff?.role === 'admin') {
        const linksContainer = document.getElementById('quickLinks');
        const managerLink = document.createElement('a');
        managerLink.href = 'manager.html';
        managerLink.className = 'quick-link manager-only';
        managerLink.innerHTML = `
          <div class="icon">ðŸ“Š</div>
          <div class="label">Dashboard</div>
        `;
        linksContainer.appendChild(managerLink);
      }
      
      // Load clock status
      await loadStatus();
    }
    
    init();
  </script>
</body>
</html>
