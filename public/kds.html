<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>BrewHub KDS | Kitchen Display</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3"></script>
    <script src="/js/auth.js"></script>
    
    <style>
        body { background-color: #0f172a; color: #f8fafc; overflow-x: hidden; font-family: sans-serif; }
        .kds-order-grid { scrollbar-gutter: stable; }
        .stale-pulse { 
            animation: pulse 2s infinite; 
            border-color: #ef4444 !important; 
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.8; transform: scale(0.98); } 
        }
        button { min-height: 70px; font-size: 1.5rem !important; transition: all 0.2s ease; cursor: pointer; }
        button:active { transform: scale(0.95); }
    </style>
</head>
<body class="min-h-screen">
    <a href="#app" class="skip-link" style="position:absolute;top:-40px;left:0;background:#000;color:#fff;padding:8px;z-index:100;transition:top 0.3s;" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Skip to main content</a>

    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="text-8xl mb-6">‚òï</div>
                <p class="text-3xl text-slate-400 animate-pulse">Booting up the espresso machine...</p>
            </div>
        </div>
    </div>

    <script>
        // XSS Protection
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // --- USE AUTH.JS CLIENT ---
        // Wait for brewAuth to be ready, then use its client
        var sbClient = null;
        async function initSupabase() {
            while (!window.brewAuth?.client) await new Promise(r => setTimeout(r, 50));
            sbClient = window.brewAuth.client;
        }

        // --- STATE ---
        var orders = [];
        var lastUpdated = new Date();
        var fetchDebounceTimer = null;
        var fetchAbortController = null;
        var isFetching = false;

        // --- HELPERS ---
        // This was the missing piece causing your ReferenceError!
        async function authHeaders() {
            const { data: { session } } = await sbClient.auth.getSession();
            return {
                'Content-Type': 'application/json',
                'Authorization': session ? `Bearer ${session.access_token}` : '',
                'X-BrewHub-Action': 'true'
            };
        }

        function timeAgo(date) {
            var seconds = Math.floor((new Date() - new Date(date)) / 1000);
            return seconds < 60 ? seconds + 's' : Math.floor(seconds / 60) + 'm';
        }

        function isStale(createdAt) {
            return (new Date() - new Date(createdAt)) > 1000 * 60 * 10;
        }

        function formatCustomizations(customs) {
            if (!customs) return "";
            if (typeof customs === 'string') return escapeHtml(customs);
            try {
                return Object.entries(customs).map(([k, v]) => escapeHtml(k) + ": " + escapeHtml(v)).join(', ');
            } catch(e) { return ""; }
        }

        // --- DATA FETCHING (debounced + abortable + merge-aware) ---
        function debouncedFetchOrders() {
            clearTimeout(fetchDebounceTimer);
            fetchDebounceTimer = setTimeout(fetchOrders, 500);
        }

        /**
         * Fetches open orders from the database.
         * @param {Object} opts
         * @param {boolean} opts.silent - When true (used by the poller), only
         *   re-renders if the data actually changed, preventing UI flashes.
         */
        async function fetchOrders(opts) {
            var silent = opts && opts.silent;
            if (isFetching) return; // skip if already in-flight
            isFetching = true;

            // Abort any lingering previous request
            if (fetchAbortController) fetchAbortController.abort();
            fetchAbortController = new AbortController();

            try {
                var { data, error } = await sbClient
                    .from('orders')
                    .select('*, coffee_orders!order_id (*)')
                    .in('status', ['pending', 'unpaid', 'paid', 'preparing', 'ready'])
                    .order('created_at', { ascending: true })
                    .abortSignal(fetchAbortController.signal);

                if (error) throw error;

                var incoming = data || [];

                // Silent mode: only re-render when the dataset actually changed
                if (silent && ordersEqual(orders, incoming)) return;

                orders = incoming;
                lastUpdated = new Date();
                render();
            } catch (err) {
                if (err.name === 'AbortError') return; // expected, ignore
                console.error("KDS: Fetch Error:", err);
            } finally {
                isFetching = false;
            }
        }

        /** Shallow compare two order arrays by id + status to detect real changes */
        function ordersEqual(a, b) {
            if (a.length !== b.length) return false;
            for (var i = 0; i < a.length; i++) {
                if (a[i].id !== b[i].id || a[i].status !== b[i].status) return false;
            }
            return true;
        }

        // --- STATUS UPDATE ---
        async function updateStatus(orderId, newStatus) {
            try {
                console.log(`KDS: Requesting status change to ${newStatus}...`);

                // 1. Optimistic UI update
                orders = orders.map(o => o.id === orderId ? { ...o, status: newStatus } : o);
                render();

                // 2. Call Netlify Function with Auth
                const response = await fetch('/.netlify/functions/update-order-status', {
                    method: 'POST',
                    headers: await authHeaders(),
                    body: JSON.stringify({ orderId, status: newStatus })
                });

                if (!response.ok) {
                    const errorMsg = await response.text();
                    throw new Error(errorMsg || 'Failed to update');
                }

                console.log("KDS: Update verified by server.");
            } catch (err) {
                console.error("KDS Update Error:", err);
                // On error, the card will "flash" back to its real DB state
                fetchOrders();
            }
        }

        // --- UI RENDERING ---
        function render() {
            var app = document.getElementById('app');
            var statusStyles = {
                pending: 'border-red-500 bg-red-500/10 text-red-400 animate-pulse',
                unpaid: 'border-red-500 bg-red-500/10 text-red-400 animate-pulse',
                paid: 'border-emerald-500 bg-emerald-500/10 text-emerald-400',
                preparing: 'border-amber-500 bg-amber-500/10 text-amber-400',
                ready: 'border-blue-500 bg-blue-500/10 text-blue-400'
            };

            /* WCAG 1.4.1 ‚Äî non-color status cues */
            var statusIcons = {
                pending: '‚ö†Ô∏è',
                unpaid:  '‚ö†Ô∏è',
                paid:    '‚úÖ',
                preparing: 'üî•',
                ready:   'üîî'
            };
            var statusLabels = {
                pending: 'Needs Payment',
                unpaid:  'Needs Payment',
                paid:    'Paid',
                preparing: 'Preparing',
                ready:   'Ready for Pickup'
            };

            app.innerHTML = `
                <div class="p-10">
                    <header class="flex flex-wrap justify-between items-end mb-12 border-b-2 border-slate-700 pb-8 gap-4">
                        <div>
                            <h1 class="text-4xl md:text-6xl font-black text-amber-500 tracking-tighter uppercase">BrewHub <span class="text-white">KDS</span></h1>
                            <p class="text-xl md:text-2xl text-slate-500 mt-2 font-mono italic">SYSTEM ONLINE</p>
                        </div>
                        <div class="text-right flex flex-col items-end gap-3">
                            <nav class="flex flex-wrap gap-2 text-lg">
                                <a href="staff-hub.html" class="text-slate-400 hover:text-amber-400 transition-colors min-h-[48px] min-w-[48px] px-3 py-2 inline-flex items-center">Staff Hub</a>
                                <a href="cafe.html" class="text-slate-400 hover:text-amber-400 transition-colors min-h-[48px] min-w-[48px] px-3 py-2 inline-flex items-center">Cafe POS</a>
                                <a href="manager.html" class="text-slate-400 hover:text-amber-400 transition-colors min-h-[48px] min-w-[48px] px-3 py-2 inline-flex items-center">Dashboard</a>
                            </nav>
                            <p class="text-2xl text-slate-400 font-mono">${lastUpdated.toLocaleTimeString()}</p>
                            <button id="kds-sync-btn" class="bg-slate-800 px-6 py-2 rounded-xl text-2xl hover:bg-slate-700" aria-label="Sync orders">üîÑ SYNC</button>
                        </div>
                    </header>

                    <div class="kds-order-grid grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-10">
                        ${orders.length === 0 ? `
                            <div class="col-span-full text-center py-60 opacity-20">
                                <h2 class="text-6xl font-black italic">NO ORDERS IN QUEUE</h2>
                            </div>
                        ` : orders.map(order => {
                            var style = statusStyles[order.status] || 'border-slate-500';
                            var stale = isStale(order.created_at) && order.status !== 'ready';
                            
                            return `
                                <div class="bg-slate-800 rounded-[2rem] border-t-[12px] shadow-2xl flex flex-col h-full ${style} ${stale ? 'stale-pulse' : ''}">
                                    <div class="p-8 border-b border-slate-700 flex justify-between items-start">
                                        <div>
                                            ${(order.status === 'pending' || order.status === 'unpaid' || !order.payment_id) ? '<p class="text-xs font-bold text-red-500 mb-1 animate-pulse">‚ö†Ô∏è COLLECT PAYMENT</p>' : ''}
                                            <h3 class="text-4xl font-black text-white leading-none">${escapeHtml(order.customer_name) || 'Guest'}</h3>
                                            <p class="text-2xl font-mono text-slate-400 mt-3">${timeAgo(order.created_at)} ago</p>
                                        </div>
                                        <span class="text-lg font-bold uppercase px-4 py-1 rounded-lg ${style}" role="status" aria-label="${statusLabels[order.status] || order.status}">${statusIcons[order.status] || ''} ${escapeHtml(statusLabels[order.status] || order.status)}</span>
                                    </div>
                                    <div class="p-8 flex-grow space-y-6">
                                        ${(order.coffee_orders || []).map(item => `
                                            <div class="border-l-4 border-amber-500/30 pl-4">
                                                <p class="text-4xl font-bold text-slate-100">${escapeHtml(item.drink_name)}</p>
                                                <p class="text-2xl text-amber-400 font-medium mt-1 leading-tight">${formatCustomizations(item.customizations)}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="p-8 bg-slate-900/40 rounded-b-[2rem]">
                                        ${(order.status === 'paid' || order.status === 'unpaid' || order.status === 'pending') ? 
                                            `<button data-order-id="${escapeHtml(order.id)}" data-next-status="preparing" class="kds-status-btn w-full bg-emerald-600 hover:bg-emerald-500 text-white rounded-2xl font-black shadow-lg" aria-label="Start preparing order for ${escapeHtml(order.customer_name) || 'Guest'}">‚ñ∂ START PREPARING</button>` : 
                                          order.status === 'preparing' ? 
                                            `<button data-order-id="${escapeHtml(order.id)}" data-next-status="ready" class="kds-status-btn w-full bg-amber-600 hover:bg-amber-500 text-white rounded-2xl font-black shadow-lg" aria-label="Mark order ready for ${escapeHtml(order.customer_name) || 'Guest'}">üîî ORDER UP!</button>` : 
                                            `<button data-order-id="${escapeHtml(order.id)}" data-next-status="completed" class="kds-status-btn w-full bg-slate-600 hover:bg-slate-500 text-white rounded-2xl font-black" aria-label="Mark order completed for ${escapeHtml(order.customer_name) || 'Guest'}">‚úì COMPLETED</button>`
                                        }
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            // Bind SYNC button listener after rendering
            var syncBtn = document.getElementById('kds-sync-btn');
            if (syncBtn) syncBtn.addEventListener('click', function() { fetchOrders(); });
        }

        // --- STARTUP ---
        async function init() {
            // Wait for brewAuth and init client
            while (!window.brewAuth) await new Promise(r => setTimeout(r, 100));
            await initSupabase();
            await window.brewAuth.protectPage({ requiredRole: 'staff' });

            // Delegated click handler ‚Äî registered ONCE, survives re-renders
            document.getElementById('app').addEventListener('click', function(e) {
                var btn = e.target.closest('.kds-status-btn');
                if (btn) {
                    var orderId = btn.getAttribute('data-order-id');
                    var nextStatus = btn.getAttribute('data-next-status');
                    if (orderId && nextStatus) updateStatus(orderId, nextStatus);
                }
            });

            fetchOrders();

            // ‚îÄ‚îÄ LAYER 1: Realtime subscription with reconnect reconciliation ‚îÄ‚îÄ
            // When the channel reaches SUBSCRIBED (including after a reconnect),
            // we re-fetch all open orders so nothing is missed during downtime.
            sbClient.channel('kds-realtime')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => debouncedFetchOrders())
                .on('postgres_changes', { event: '*', schema: 'public', table: 'coffee_orders' }, () => debouncedFetchOrders())
                .subscribe(function (status) {
                    console.log('KDS: Realtime channel status ‚Üí', status);
                    if (status === 'SUBSCRIBED') {
                        fetchOrders(); // reconcile on every (re)subscribe
                    }
                });

            // ‚îÄ‚îÄ LAYER 2: Browser online event ‚Äì instant recovery after Wi-Fi drop ‚îÄ‚îÄ
            window.addEventListener('online', function () {
                console.log('KDS: Network restored ‚Äî reconciling orders‚Ä¶');
                fetchOrders();
            });

            // ‚îÄ‚îÄ LAYER 3: Failsafe background poller (every 60 s) ‚îÄ‚îÄ
            // Silent mode merges data without flashing/resetting the UI.
            setInterval(function () {
                fetchOrders({ silent: true });
            }, 60000);

            // Gentle UI refresh for "time ago" labels (no network call)
            setInterval(render, 30000);
        }
        init();
    </script>
</body>
</html>