<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>BrewHub Manager Dashboard</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3"></script>
  
  <script src="/js/auth.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #0f0f0f; min-height: 100vh; color: #f5f5f5; }
    .header { background: #1a1a1a; padding: 1rem 2rem; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 0.75rem; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 40; }
    .logo { font-size: 1.5rem; font-weight: 700; color: #f5f5f5; cursor: pointer; }
    .logo span { color: #f39c12; }
    .nav-links { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
    .nav-links a { color: #ccc; text-decoration: none; margin-left: 0; padding: 0.5rem 0.75rem; font-size: 0.9rem; transition: color 0.2s; min-height: 44px; display: inline-flex; align-items: center; }
    .nav-links a:hover, .nav-links a.active { color: #f39c12; }
    .container { padding: 2rem; max-width: 1400px; margin: 0 auto; }
    
    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; }
    @media (min-width: 768px) { .stats-grid { grid-template-columns: repeat(4, 1fr); gap: 1.5rem; } }
    .stat-card { background: #1a1a1a; border-radius: 16px; padding: 1.5rem; border: 1px solid #333; }
    .stat-label { font-size: 0.85rem; color: #888; margin-bottom: 0.5rem; }
    .stat-value { font-size: 2rem; font-weight: 700; color: #f5f5f5; }
    .stat-value.revenue { color: #27ae60; }
    .stat-value.orders { color: #3498db; }
    .stat-change { font-size: 0.8rem; color: #666; margin-top: 0.5rem; }
    
    /* Main Grid */
    .main-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
    @media (min-width: 1024px) { .main-grid { grid-template-columns: 1fr 400px; } }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .inventory-table { background: #1a1a1a; border-radius: 16px; overflow: hidden; border: 1px solid #333; }
    .inventory-header { display: grid; grid-template-columns: 2fr 1fr 1fr 120px; padding: 1rem 1.5rem; background: #222; font-size: 0.75rem; color: #888; }
    .inventory-row { display: grid; grid-template-columns: 2fr 1fr 1fr 120px; padding: 1rem 1.5rem; border-bottom: 1px solid #222; align-items: center; }
    .stock-btn { min-width: 48px; min-height: 48px; width: 48px; height: 48px; border-radius: 8px; border: none; background: #333; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .stock-btn:hover { background: #444; }
    
    .sidebar { display: flex; flex-direction: column; gap: 1.5rem; }
    .card { background: #1a1a1a; border-radius: 16px; padding: 1.5rem; border: 1px solid #333; }
    .activity-list { display: flex; flex-direction: column; gap: 0.75rem; }
    
    /* KDS Mini */
    .kds-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .kds-card { background: #1a1a1a; border-radius: 12px; border: 1px solid #333; overflow: hidden; }
    .kds-card.paid { border-top: 4px solid #27ae60; }
    .kds-card.preparing { border-top: 4px solid #f39c12; }
    .kds-card.ready { border-top: 4px solid #3498db; }
    .kds-header { padding: 0.75rem 1rem; background: #222; display: flex; justify-content: space-between; align-items: center; }
    .kds-items { padding: 0.75rem 1rem; font-size: 0.9rem; }
    .kds-item { padding: 0.25rem 0; border-bottom: 1px solid #2a2a2a; }
    .kds-item:last-child { border-bottom: none; }
    .kds-actions { padding: 0.75rem 1rem; background: #1a1a1a; display: flex; gap: 0.5rem; }
    .kds-btn { flex: 1; padding: 0.75rem; min-height: 48px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
    .kds-btn.start { background: #27ae60; color: #fff; }
    .kds-btn.ready { background: #f39c12; color: #fff; }
    .kds-btn.done { background: #3498db; color: #fff; }

    /* Virtual Thermal Printer */
    .printer-section { margin-top: 2rem; }
    .receipt-roll {
      display: flex; flex-direction: column; gap: 1.25rem;
      max-height: 600px; overflow-y: auto; padding: 1rem;
      scrollbar-width: thin; scrollbar-color: #444 #1a1a1a;
    }
    .receipt-roll::-webkit-scrollbar { width: 6px; }
    .receipt-roll::-webkit-scrollbar-track { background: #1a1a1a; }
    .receipt-roll::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    .thermal-receipt {
      background: #fffdfa; color: #111; font-family: 'Courier New', Consolas, monospace;
      font-size: 12px; line-height: 1.35; white-space: pre; padding: 1.25rem 1rem;
      border-radius: 4px 4px 0 0; position: relative; max-width: 340px;
      box-shadow: 2px 4px 12px rgba(0,0,0,0.45);
    }
    .thermal-receipt::after {
      content: ''; display: block; position: absolute; bottom: -8px; left: 0; right: 0; height: 8px;
      background: linear-gradient(135deg, #fffdfa 33.33%, transparent 33.33%),
                  linear-gradient(225deg, #fffdfa 33.33%, transparent 33.33%);
      background-size: 12px 8px;
    }
    .thermal-receipt .receipt-time {
      display: block; text-align: right; font-size: 10px; color: #888; margin-top: 0.5rem;
    }
    .thermal-receipt.receipt-new {
      animation: receiptSlideIn 0.5s ease-out;
    }
    @keyframes receiptSlideIn {
      0%   { opacity: 0; transform: translateY(-20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .receipt-flash {
      animation: flashHighlight 1s ease-out;
    }
    @keyframes flashHighlight {
      0%   { box-shadow: 0 0 20px rgba(243,156,18,0.8); }
      100% { box-shadow: 2px 4px 12px rgba(0,0,0,0.45); }
    }
    .printer-empty { padding: 2rem; text-align: center; color: #666; font-size: 0.85rem; }

    /* ‚îÄ‚îÄ Tab System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .tab-bar { display: flex; gap: 4px; overflow-x: auto; padding: 0 2rem; background: #1a1a1a; border-bottom: 1px solid #333; }
    .tab-bar::-webkit-scrollbar { display: none; }
    .tab-btn { background: none; border: none; border-bottom: 2px solid transparent; color: #888; padding: 0.75rem 1.25rem; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: color 0.2s, border-color 0.2s; display: flex; align-items: center; gap: 6px; }
    .tab-btn:hover { color: #ccc; }
    .tab-btn.active { color: #f39c12; border-bottom-color: #f39c12; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* ‚îÄ‚îÄ Catalog Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
    .catalog-card { background: #1a1a1a; border-radius: 12px; border: 1px solid #333; padding: 1.25rem; position: relative; }
    .catalog-card .cat-name { font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem; }
    .catalog-card .cat-price { color: #27ae60; font-weight: 700; }
    .catalog-card .cat-badge { position: absolute; top: 12px; right: 12px; background: #333; color: #aaa; font-size: 0.65rem; padding: 2px 8px; border-radius: 20px; text-transform: uppercase; font-weight: 700; }
    .catalog-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
    .catalog-actions button { flex: 1; padding: 0.75rem; min-height: 48px; border-radius: 8px; border: 1px solid #444; background: #222; color: #ccc; font-size: 0.85rem; cursor: pointer; transition: background 0.2s; }
    .catalog-actions button:hover { background: #333; }
    .catalog-actions button.cat-delete { border-color: #c0392b; color: #e74c3c; }
    .catalog-actions button.cat-delete:hover { background: #2c1010; }
    #catalog-add-form { background: #1a1a1a; border-radius: 12px; border: 1px solid #333; padding: 1.5rem; margin-bottom: 1.5rem; display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
    @media (min-width: 640px) { #catalog-add-form { grid-template-columns: 1fr 1fr; } }
    #catalog-add-form input, #catalog-add-form select { background: #222; border: 1px solid #444; color: #f5f5f5; padding: 0.5rem 0.75rem; border-radius: 8px; font-size: 0.85rem; }
    #catalog-add-form button { grid-column: span 2; background: #27ae60; color: #fff; border: none; padding: 0.6rem; border-radius: 8px; cursor: pointer; font-weight: 600; }

    /* ‚îÄ‚îÄ Image Drop Zone ‚îÄ‚îÄ */
    .image-drop-zone { border: 2px dashed #444; border-radius: 12px; padding: 1.25rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer; transition: border-color 0.2s, background 0.2s; min-height: 120px; text-align: center; position: relative; }
    .image-drop-zone.drag-over { border-color: #3498db; background: rgba(52,152,219,0.08); }
    .image-drop-zone:hover { border-color: #666; }
    .drop-prompt { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; color: #888; font-size: 0.85rem; pointer-events: none; }
    .drop-preview-img { max-height: 140px; max-width: 100%; border-radius: 8px; object-fit: cover; border: 1px solid #333; }
    .drop-uploading .pulse-text { color: #3498db; animation: pulse-fade 1.2s infinite; font-size: 0.85rem; }
    @keyframes pulse-fade { 0%,100%{ opacity:0.4; } 50%{ opacity:1; } }
    .drop-error { color: #e74c3c; font-size: 0.75rem; min-height: 1rem; }
    .price-field { display: flex; align-items: center; background: #222; border: 1px solid #444; border-radius: 8px; overflow: hidden; }
    .price-field .price-prefix { padding: 0.5rem 0.5rem 0.5rem 0.75rem; color: #27ae60; font-weight: 700; font-size: 0.9rem; }
    .price-field input { background: transparent; border: none; color: #f5f5f5; padding: 0.5rem 0.75rem 0.5rem 0; font-size: 0.85rem; flex: 1; outline: none; }
    .price-field input:focus-visible { outline: 2px solid #f59e0b; outline-offset: 2px; }
    .cat-img-thumb { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #333; }
    .cat-img-placeholder { width: 100%; height: 120px; border-radius: 8px; margin-bottom: 0.5rem; background: #222; display: flex; align-items: center; justify-content: center; color: #444; font-size: 2rem; border: 1px dashed #333; }

    /* ‚îÄ‚îÄ Edit Modal ‚îÄ‚îÄ */
    .edit-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
    .edit-modal { background: #1a1a1a; border-radius: 16px; border: 1px solid #444; padding: 1.5rem; width: 90%; max-width: 440px; max-height: 90vh; overflow-y: auto; }
    .edit-modal h3 { margin: 0 0 1rem; font-size: 1.1rem; }
    .edit-field { margin-bottom: 0.75rem; }
    .edit-field label { display: block; color: #888; font-size: 0.75rem; margin-bottom: 4px; text-transform: uppercase; font-weight: 600; }
    .edit-field input, .edit-field select { width: 100%; background: #222; border: 1px solid #444; color: #f5f5f5; padding: 0.5rem 0.75rem; border-radius: 8px; font-size: 0.85rem; box-sizing: border-box; }
    .edit-btns { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .edit-btns button { flex: 1; padding: 0.6rem; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; }
    .edit-btns .save-btn { background: #27ae60; color: #fff; }
    .edit-btns .cancel-btn { background: #333; color: #ccc; }

    /* ‚îÄ‚îÄ Hiring Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .hiring-filters { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.25rem; }
    .hiring-pill { background: #222; border: 1px solid #333; color: #888; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.75rem; cursor: pointer; font-weight: 600; text-transform: uppercase; transition: all 0.2s; }
    .hiring-pill:hover { border-color: #555; color: #ccc; }
    .hiring-pill.active { background: rgba(243,156,18,0.15); border-color: rgba(243,156,18,0.4); color: #f39c12; }
    .applicant-card { background: #1a1a1a; border-radius: 12px; border: 1px solid #333; margin-bottom: 0.75rem; overflow: hidden; }
    .applicant-row { display: flex; align-items: center; justify-content: space-between; gap: 1rem; padding: 1rem 1.25rem; cursor: pointer; transition: background 0.2s; }
    .applicant-row:hover { background: #222; }
    .applicant-avatar { width: 36px; height: 36px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; color: #888; flex-shrink: 0; }
    .applicant-name { font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .applicant-email { font-size: 0.75rem; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .applicant-meta { display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
    .app-status { padding: 3px 10px; border-radius: 20px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; }
    .app-status.pending { background: rgba(243,156,18,0.15); color: #f39c12; }
    .app-status.reviewed { background: rgba(52,152,219,0.15); color: #3498db; }
    .app-status.interview { background: rgba(155,89,182,0.15); color: #9b59b6; }
    .app-status.hired { background: rgba(39,174,96,0.15); color: #27ae60; }
    .app-status.rejected { background: rgba(231,76,60,0.15); color: #e74c3c; }
    .resume-link { background: #222; border: 1px solid #444; color: #f39c12; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; text-decoration: none; white-space: nowrap; }
    .resume-link:hover { background: #333; }
    .applicant-detail { padding: 0 1.25rem 1.25rem; border-top: 1px solid #2a2a2a; display: none; }
    .applicant-detail.open { display: block; padding-top: 1rem; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .detail-label { font-size: 0.7rem; color: #666; text-transform: uppercase; font-weight: 600; letter-spacing: 0.05em; margin-bottom: 0.25rem; }
    .detail-value { font-size: 0.85rem; color: #ccc; }
    .status-btns { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
    .status-btns button { padding: 0.5rem 1rem; min-height: 44px; border-radius: 6px; border: 1px solid #444; background: #222; color: #ccc; font-size: 0.8rem; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .status-btns button:hover { background: #333; }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link" style="position:absolute;top:-40px;left:0;background:#000;color:#fff;padding:8px;z-index:100;transition:top 0.3s;" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Skip to main content</a>
  <header class="header">
    <div class="logo" id="logo-nav" style="cursor:pointer;">Brew<span>Hub</span> Dashboard</div>
    <nav class="nav-links">
      <a href="staff-hub.html">Staff Hub</a>
      <a href="kds.html">KDS</a>
      <a href="cafe.html">Cafe POS</a>
      <a href="parcels.html">Parcel Hub</a>
      <a href="scan.html">Inventory</a>
      <a href="manager.html" class="active">Dashboard</a>
      <a href="#" id="logout-link" style="color: #e74c3c;">Logout</a>
    </nav>
  </header>

  <!-- ‚îÄ‚îÄ Tab Bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="overview" role="tab" aria-selected="true">üìä Overview</button>
    <button class="tab-btn" data-tab="catalog" role="tab" aria-selected="false">üçΩÔ∏è Menu &amp; Catalog</button>
    <button class="tab-btn" data-tab="hiring" role="tab" aria-selected="false">üìã Hiring</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê TAB: OVERVIEW (existing dashboard) ‚ïê‚ïê‚ïê -->
  <main class="container tab-panel active" id="tab-overview">
    <!-- ‚îÄ‚îÄ Vital Signs Hero Row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;margin-bottom:2rem;">
      <div style="background:linear-gradient(135deg,#1a1a1a 60%,#1e3a2f);border-radius:20px;padding:2rem;border:1px solid #27ae60;">
        <div style="font-size:0.75rem;color:#888;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:0.5rem;">üí∞ Net Sales <button id="refresh-sales-btn" style="background:none;border:none;cursor:pointer;font-size:0.8rem;" aria-label="Refresh sales data">üîÑ</button></div>
        <div style="font-size:3rem;font-weight:800;color:#27ae60;line-height:1;" id="totalRevenue">$0.00</div>
        <div style="font-size:0.8rem;color:#666;margin-top:0.5rem;" id="revenueChange">Syncing...</div>
      </div>
      <div style="background:linear-gradient(135deg,#1a1a1a 60%,#2a2040);border-radius:20px;padding:2rem;border:1px solid #9b59b6;">
        <div style="font-size:0.75rem;color:#888;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:0.5rem;">üë• Active Shifts</div>
        <div style="font-size:3rem;font-weight:800;color:#9b59b6;line-height:1;" id="activeStaff">0</div>
        <div style="font-size:0.8rem;color:#666;margin-top:0.5rem;" id="staffList">No active shifts</div>
      </div>
      <div style="background:linear-gradient(135deg,#1a1a1a 60%,#2a2a10);border-radius:20px;padding:2rem;border:1px solid #f39c12;">
        <div style="font-size:0.75rem;color:#888;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:0.5rem;">üì¶ Orders Today</div>
        <div style="font-size:3rem;font-weight:800;color:#f39c12;line-height:1;" id="totalOrders">0</div>
        <div style="font-size:0.8rem;color:#666;margin-top:0.5rem;" id="ordersChange">Live</div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Est. Daily Labor</div>
        <div class="stat-value" id="dailyLabor">$0.00</div>
        <div class="stat-change">Total Shift Cost</div>
      </div>
    </div>

    <div class="main-grid">
      <section>
        <div class="section-header">
          <h2>üì¶ Inventory Status</h2>
          <button class="refresh-btn" id="refresh-inventory-btn" style="color:#888; background:none; border:1px solid #333; padding:5px 10px; cursor:pointer;" aria-label="Refresh inventory">‚Üª Refresh</button>
        </div>
        <div class="inventory-table">
          <div class="inventory-header">
            <span>Item</span>
            <span>Current Stock</span>
            <span>Threshold</span>
            <span>Adjust</span>
          </div>
          <div id="inventoryList"></div>
        </div>
      </section>

      <aside class="sidebar">
        <div class="card">
          <h3>‚ö° Recent Activity</h3>
          <div class="activity-list" id="activityList">
              <div style="font-size:0.8rem; color:#666;">Waiting for events...</div>
          </div>
        </div>
      </aside>
    </div>

    <!-- KDS Section -->
    <section style="margin-top: 2rem;">
      <div class="section-header">
        <h2>‚òï Active Orders (KDS)</h2>
        <button id="refresh-kds-btn" style="color:#888; background:none; border:1px solid #333; padding:5px 10px; cursor:pointer;" aria-label="Refresh orders">‚Üª Refresh</button>
      </div>
      <div class="kds-grid" id="kdsGrid">
        <div style="padding: 1rem; color: #666;">Loading orders...</div>
      </div>
    </section>

    <!-- Virtual Thermal Printer -->
    <section class="printer-section">
      <div class="section-header">
        <h2>üñ®Ô∏è Live Receipt Roll</h2>
        <button id="refresh-receipts-btn" style="color:#888; background:none; border:1px solid #333; padding:5px 10px; cursor:pointer;" aria-label="Refresh receipts">‚Üª Refresh</button>
      </div>
      <div class="receipt-roll" id="receiptRoll">
        <div class="printer-empty">No receipts yet ‚Äî they'll appear here in real time.</div>
      </div>
    </section>

    <!-- Payroll Section -->
    <section style="margin-top: 2rem;">
      <div class="section-header">
        <h2>üí∞ Payroll Tally</h2>
        <div style="display:flex;align-items:center;gap:0.75rem;">
          <button id="payroll-csv-btn" onclick="downloadPayrollCsv()" disabled style="background:#1a6b35;color:#fff;border:none;padding:0.5rem 1rem;border-radius:8px;font-size:0.8rem;font-weight:600;cursor:pointer;opacity:0.4;transition:opacity 0.2s;">üì• Download Gusto/ADP CSV</button>
          <span id="grand-total" style="color: #27ae60; font-size: 1.5rem; font-weight: 700;">$0.00</span>
        </div>
      </div>
      <div class="inventory-table">
        <div class="inventory-header" style="grid-template-columns: 2fr 1fr 1fr 1fr 100px;">
          <span>Staff</span>
          <span>Rate</span>
          <span>Hours</span>
          <span>Earned</span>
          <span>Status</span>
        </div>
        <div id="payroll-list">
          <div style="padding: 1rem 1.5rem; color: #666;">Loading payroll...</div>
        </div>
      </div>
    </section>
  </main>

  <!-- ‚ïê‚ïê‚ïê TAB: MENU & CATALOG ‚ïê‚ïê‚ïê -->
  <div class="container tab-panel" id="tab-catalog">
    <div class="section-header">
      <h2>üçΩÔ∏è Menu &amp; Catalog</h2>
      <button id="refresh-catalog-btn" style="color:#888;background:none;border:1px solid #333;padding:5px 10px;cursor:pointer;" aria-label="Refresh catalog">‚Üª Refresh</button>
    </div>

    <form id="catalog-add-form" autocomplete="off">
      <input type="text" name="name" placeholder="Item name" required />
      <div class="price-field">
        <span class="price-prefix">$</span>
        <input type="number" name="price_dollars" placeholder="0.00" min="0" step="0.01" required />
      </div>
      <input type="text" name="description" placeholder="Short description" />
      <select name="category">
        <option value="menu">‚òï Cafe Menu</option>
        <option value="merch">üõçÔ∏è Merch &amp; Beans</option>
      </select>
      <div class="image-drop-zone" id="add-image-drop" style="grid-column:span 2;">
        <img id="add-image-preview" class="drop-preview-img" style="display:none;" alt="Preview" />
        <div class="drop-prompt" id="add-drop-prompt">
          <span style="font-size:2rem;">üì∏</span>
          <span>Drag &amp; drop a photo here<br><small style="color:#5dade2;text-decoration:underline;">or click to browse</small></span>
        </div>
        <div class="drop-uploading" id="add-drop-uploading" style="display:none;">
          <span class="pulse-text">Uploading‚Ä¶</span>
        </div>
        <input type="file" id="add-image-file" accept="image/png,image/jpeg,image/webp,image/gif" style="display:none;" />
        <input type="hidden" name="image_url" id="add-image-url" />
        <div class="drop-error" id="add-drop-error"></div>
      </div>
      <select name="active">
        <option value="true">‚úÖ Active (visible to customers)</option>
        <option value="false">üôà Hidden</option>
      </select>
      <button type="submit">+ Add Item</button>
    </form>

    <div class="catalog-grid" id="catalog-grid">
      <div style="padding:1rem;color:#666;">Loading catalog...</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê TAB: HIRING ‚ïê‚ïê‚ïê -->
  <div class="container tab-panel" id="tab-hiring">
    <div class="section-header">
      <h2>üìã Applicants</h2>
      <button id="refresh-hiring-btn" style="color:#888;background:none;border:1px solid #333;padding:5px 10px;cursor:pointer;" aria-label="Refresh applicants">‚Üª Refresh</button>
    </div>
    <div class="hiring-filters" id="hiring-filters"></div>
    <div id="applicants-list">
      <div style="padding:1rem;color:#666;">Loading applications...</div>
    </div>
  </div>

  <script>
    // XSS Protection
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // Static inventory data (Placeholder for now)
    const inventory = [
      { name: 'Espresso Beans', category: 'Coffee', current: 3, threshold: 10, unit: 'lbs' },
      { name: 'Oat Milk', category: 'Dairy Alt', current: 2, threshold: 8, unit: 'gal' },
      { name: 'Vanilla Syrup', category: 'Syrups', current: 4, threshold: 4, unit: 'bottles' }
    ];

    function renderInventory() {
      const container = document.getElementById('inventoryList');
      container.innerHTML = inventory.map((item, i) => `
        <div class="inventory-row">
          <div><div class="item-name">${escapeHtml(item.name)}</div><div class="item-category">${escapeHtml(item.category)}</div></div>
          <div class="stock-level">${item.current} ${escapeHtml(item.unit)}</div>
          <div class="threshold">${item.threshold} ${escapeHtml(item.unit)}</div>
          <div class="stock-controls">
            <button class="stock-btn" data-stock-index="${i}" data-stock-delta="-1" aria-label="Decrease stock for ${escapeHtml(item.name)}">‚àí</button>
            <button class="stock-btn" data-stock-index="${i}" data-stock-delta="1" aria-label="Increase stock for ${escapeHtml(item.name)}">+</button>
          </div>
        </div>
      `).join('');
    }

    function adjustStock(index, delta) {
      inventory[index].current = Math.max(0, inventory[index].current + delta);
      renderInventory();
    }

    // --- KDS Functions ---
    let kdsOrders = [];
    
    async function loadKdsOrders() {
      try {
        const client = window.brewAuth.client;
        if (!client) return;
        
        const { data, error } = await client
          .from('orders')
          .select('*, coffee_orders!order_id(*)')
          .in('status', ['pending', 'unpaid', 'paid', 'preparing', 'ready'])
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        kdsOrders = data || [];
        renderKds();
      } catch (err) {
        console.error('KDS fetch failed:', err);
        document.getElementById('kdsGrid').innerHTML = '<div style="padding:1rem;color:#e74c3c;">Failed to load orders</div>';
      }
    }
    
    function renderKds() {
      const grid = document.getElementById('kdsGrid');
      if (kdsOrders.length === 0) {
        grid.innerHTML = '<div style="padding:1rem;color:#666;">No active orders ‚úì</div>';
        return;
      }
      
      grid.innerHTML = kdsOrders.map(order => {
        const items = order.coffee_orders || [];
        const timeAgo = Math.floor((Date.now() - new Date(order.created_at)) / 60000);
        const btnClass = order.status === 'paid' ? 'start' : order.status === 'preparing' ? 'ready' : 'done';
        const btnText = order.status === 'paid' ? '‚ñ∂ Start' : order.status === 'preparing' ? 'üîî Ready' : '‚úì Done';
        const nextStatus = order.status === 'paid' ? 'preparing' : order.status === 'preparing' ? 'ready' : 'completed';
        
        return `
          <div class="kds-card ${escapeHtml(order.status)}">
            <div class="kds-header">
              <strong>${escapeHtml(order.customer_name) || 'Guest'}</strong>
              <span style="font-size:0.75rem;color:#888;">${timeAgo}m ago</span>
            </div>
            <div class="kds-items">
              ${items.map(i => `<div class="kds-item">‚òï ${escapeHtml(i.drink_name)}</div>`).join('') || '<div class="kds-item" style="color:#666;">No items</div>'}
            </div>
            <div class="kds-actions">
              <button class="kds-btn ${btnClass}" data-order-id="${escapeHtml(order.id)}" data-next-status="${escapeHtml(nextStatus)}">${btnText}</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function updateKdsStatus(orderId, newStatus) {
      try {
        const session = window.brewAuth.session;
        const res = await fetch('/.netlify/functions/update-order-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
            'X-BrewHub-Action': 'true'
          },
          body: JSON.stringify({ orderId, status: newStatus })
        });
        
        if (!res.ok) throw new Error('Update failed');
        
        // Refresh KDS
        loadKdsOrders();
        loadSalesReport();
      } catch (err) {
        console.error('KDS update error:', err);
        alert('Failed to update order');
      }
    }

    // --- CRITICAL FIX: Auth Headers added here ---
    async function loadSalesReport() {
      try {
        const session = window.brewAuth.session;
        if (!session) return; // Wait for login

        const res = await fetch('/.netlify/functions/sales-report', {
            headers: {
                'Authorization': `Bearer ${session.access_token}`
            }
        });

        if (res.status === 401) {
            console.error("Token Expired or Invalid");
            return;
        }

        if (!res.ok) throw new Error('API Error');
        
        const data = await res.json();
        
        // Matches SQL: COALESCE(SUM(total_amount_cents), 0) / 100.0 as gross_revenue
        document.getElementById('totalRevenue').textContent = '$' + parseFloat(data.gross_revenue || 0).toFixed(2);
        document.getElementById('totalOrders').textContent = data.total_orders || 0;
        document.getElementById('revenueChange').textContent = '‚Üë Live Sync';
      } catch (err) {
        console.warn('Sales report fetch failed:', err);
        document.getElementById('totalRevenue').textContent = '$0.00';
      }
    }

    async function loadStaffStatus() {
        try {
            const client = window.brewAuth.client;
            if (!client) return;

            const { data, error } = await client
                .from('staff_directory')
                .select('*');

            if (error) throw error;
            
            // Filter locally to avoid complex DB joins for now
            const workingStaff = data.filter(s => s.is_working === true);
            
            document.getElementById('activeStaff').textContent = workingStaff.length;
            document.getElementById('staffList').textContent = workingStaff.map(s => s.name).join(', ') || 'No one active';
            
            // Calculate labor based on 'hourly_rate'
            const activeLabor = workingStaff.reduce((acc, curr) => acc + (parseFloat(curr.hourly_rate) || 0), 0);
            document.getElementById('dailyLabor').textContent = '$' + activeLabor.toFixed(2);
        } catch (e) {
            console.error("Staff fetch failed", e);
            document.getElementById('staffList').textContent = "Connection issue";
        }
    }

    var payrollExportData = [];

    async function loadPayroll() {
        try {
            const client = window.brewAuth.client;
            if (!client) return;

            const list = document.getElementById('payroll-list');
            let grandTotal = 0;
            payrollExportData = [];

            const [pRes, lRes] = await Promise.all([
                client.from('staff_directory').select('*'),
                client.from('time_logs').select('*').order('created_at', { ascending: true })
            ]);

            if (pRes.error) throw pRes.error;
            if (lRes.error) throw lRes.error;

            const employees = pRes.data || [];
            const logs = lRes.data || [];

            if (employees.length === 0) {
                list.innerHTML = '<div style="padding: 1rem 1.5rem; color: #666;">No staff found</div>';
                return;
            }

            list.innerHTML = '';

            employees.forEach(emp => {
                let totalHours = 0;
                let regularHours = 0;
                let overtimeHours = 0;
                const empLogs = logs.filter(l => l.employee_email === emp.email);
                
                // Pair INs with OUTs
                let startTime = null;
                empLogs.forEach(log => {
                    const type = (log.action_type || '').toLowerCase();
                    if (type === 'in') {
                        startTime = new Date(log.clock_in || log.created_at);
                    } else if (type === 'out' && startTime) {
                        const endTime = new Date(log.clock_out || log.created_at);
                        totalHours += (endTime - startTime) / 3600000;
                        startTime = null;
                    }
                });

                // Split at 40 h OT threshold
                if (totalHours > 40) {
                    regularHours = 40;
                    overtimeHours = totalHours - 40;
                } else {
                    regularHours = totalHours;
                }

                const rate = parseFloat(emp.hourly_rate) || 0;
                const earned = regularHours * rate + overtimeHours * rate * 1.5;
                grandTotal += earned;

                const lastLog = empLogs[empLogs.length - 1];
                const status = (lastLog?.action_type || 'OFF').toUpperCase();
                const statusColor = status === 'IN' ? '#27ae60' : '#e74c3c';

                payrollExportData.push({
                    name: emp.full_name || emp.name || 'Staff',
                    email: emp.email,
                    rate: rate,
                    regularHours: regularHours,
                    overtimeHours: overtimeHours,
                    totalHours: totalHours,
                    earned: earned,
                    status: status
                });

                var otLabel = overtimeHours > 0
                    ? '<div style="font-size:0.7rem;color:#e67e22;">' + overtimeHours.toFixed(2) + ' hrs OT (1.5√ó)</div>'
                    : '';

                list.innerHTML += `
                    <div class="inventory-row" style="grid-template-columns: 2fr 1fr 1fr 1fr 100px;">
                        <div style="min-width:0;"><strong style="display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(emp.full_name || emp.name) || 'Staff'}</strong><div style="font-size:0.75rem;color:#666;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(emp.email)}</div></div>
                        <div>$${rate.toFixed(2)}/hr</div>
                        <div>${totalHours.toFixed(2)} hrs${otLabel}</div>
                        <div style="color: #27ae60; font-weight: 600;">$${earned.toFixed(2)}</div>
                        <div><span style="background:${statusColor}; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:bold; color:white;">${escapeHtml(status)}</span></div>
                    </div>
                `;
            });

            document.getElementById('grand-total').textContent = `$${grandTotal.toFixed(2)}`;

            // Enable the CSV button now that data is loaded
            var csvBtn = document.getElementById('payroll-csv-btn');
            if (payrollExportData.length > 0) {
                csvBtn.disabled = false;
                csvBtn.style.opacity = '1';
            } else {
                csvBtn.disabled = true;
                csvBtn.style.opacity = '0.4';
            }

        } catch (e) {
            console.error("Payroll fetch failed", e);
            document.getElementById('payroll-list').innerHTML = '<div style="padding: 1rem 1.5rem; color: #e74c3c;">Failed to load payroll</div>';
        }
    }

    function downloadPayrollCsv() {
        if (payrollExportData.length === 0) return;
        var header = 'Employee Name,Email,Regular Hours (1x),Overtime Hours (1.5x),Hourly Rate,Gross Pay Estimate,Clock Status';
        var lines = payrollExportData.map(function(r) {
            return [
                '"' + (r.name || '').replace(/"/g, '""') + '"',
                '"' + (r.email || '') + '"',
                r.regularHours.toFixed(2),
                r.overtimeHours.toFixed(2),
                r.rate.toFixed(2),
                r.earned.toFixed(2),
                r.status
            ].join(',');
        });
        var csv = [header].concat(lines).join('\n');
        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'brewhub-payroll-' + new Date().toISOString().slice(0, 10) + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // --- Virtual Thermal Printer ---
    const MAX_RECEIPTS = 10;

    function renderReceiptCard(receipt, animate) {
      const el = document.createElement('div');
      el.className = 'thermal-receipt' + (animate ? ' receipt-new receipt-flash' : '');
      const ts = receipt.created_at ? new Date(receipt.created_at).toLocaleTimeString('en-US', {
        timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', hour12: true
      }) : '';
      el.textContent = receipt.receipt_text || '(empty receipt)';
      const timeSpan = document.createElement('span');
      timeSpan.className = 'receipt-time';
      timeSpan.textContent = ts;
      el.appendChild(timeSpan);
      // Remove animation classes after they finish
      if (animate) {
        el.addEventListener('animationend', function handler() {
          el.classList.remove('receipt-new', 'receipt-flash');
          el.removeEventListener('animationend', handler);
        });
      }
      return el;
    }

    function prependReceipt(receipt, animate) {
      const roll = document.getElementById('receiptRoll');
      // Remove empty-state message if present
      const empty = roll.querySelector('.printer-empty');
      if (empty) empty.remove();
      const card = renderReceiptCard(receipt, animate);
      roll.prepend(card);
      // Cap visible receipts
      while (roll.children.length > MAX_RECEIPTS) {
        roll.removeChild(roll.lastChild);
      }
    }

    async function loadReceipts() {
      try {
        const client = window.brewAuth.client;
        if (!client) return;
        const { data, error } = await client
          .from('receipt_queue')
          .select('id, receipt_text, created_at')
          .order('created_at', { ascending: false })
          .limit(5);
        if (error) throw error;
        const roll = document.getElementById('receiptRoll');
        roll.innerHTML = '';
        if (!data || data.length === 0) {
          roll.innerHTML = '<div class="printer-empty">No receipts yet ‚Äî they\'ll appear here in real time.</div>';
          return;
        }
        data.forEach(r => {
          roll.appendChild(renderReceiptCard(r, false));
        });
      } catch (err) {
        console.error('Receipt fetch failed:', err);
      }
    }

    async function init() {
      // 1. Wait safely for auth system to load
      let attempts = 0;
      while (!window.brewAuth && attempts < 50) {
        await new Promise(r => setTimeout(r, 100));
        attempts++;
      }

      if (!window.brewAuth) {
          console.error("CRITICAL: /js/auth.js failed to load.");
          return;
      }

      // 2. Protect Page - Require staff role (for clock in/out)
      const user = await window.brewAuth.protectPage({ requiredRole: 'staff' });
      if (!user) return;

      console.log("Manager Logged In:", user.email, "Role:", window.brewAuth.staff?.role);

      // Conditionally show manager features
      if (user.role !== 'manager' && user.role !== 'admin') {
        // Staff: Hide inventory section and link
        const inventorySection = document.querySelector('.main-grid section');
        if (inventorySection) inventorySection.style.display = 'none';
        const inventoryLink = document.querySelector('a[href="scan.html"]');
        if (inventoryLink) inventoryLink.style.display = 'none';

        // Staff: Hide Catalog + Hiring tabs (manager-only)
        document.querySelectorAll('[data-tab="catalog"], [data-tab="hiring"]').forEach(function(t) { t.style.display = 'none'; });
        var catalogPanel = document.getElementById('tab-catalog');
        var hiringPanel = document.getElementById('tab-hiring');
        if (catalogPanel) catalogPanel.remove();
        if (hiringPanel) hiringPanel.remove();

        // Staff: Hide payroll CSV export button
        var csvBtn = document.getElementById('payroll-csv-btn');
        if (csvBtn) csvBtn.style.display = 'none';
      }

      // 3. Populate Dashboard
      renderInventory();
      loadSalesReport();
      loadStaffStatus();
      loadPayroll();
      loadReceipts();

      // 4. Real-time subscription - refresh sales when orders change
      const client = window.brewAuth.client;
      client.channel('manager-orders')
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders' }, (payload) => {
          // Refresh sales report when any order status changes (especially to 'completed')
          console.log('Order updated:', payload.new?.status);
          loadSalesReport();
        })
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, () => {
          console.log('New order received');
          loadSalesReport();
        })
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'receipt_queue' }, (payload) => {
          console.log('New receipt:', payload.new?.id);
          prependReceipt(payload.new, true);
        })
        .subscribe((status) => {
          console.log('[REALTIME] Subscription status:', status);
        });
    }

    // --- Event Delegation ---
    document.getElementById('logo-nav').addEventListener('click', function() { window.location.href = '/staff-hub.html'; });
    document.getElementById('logout-link').addEventListener('click', function(e) { e.preventDefault(); window.brewAuth.signOut(); });
    document.getElementById('refresh-sales-btn').addEventListener('click', function() { loadSalesReport(); });
    document.getElementById('refresh-inventory-btn').addEventListener('click', function() { renderInventory(); });
    document.getElementById('refresh-kds-btn').addEventListener('click', function() { loadKdsOrders(); });
    document.getElementById('refresh-receipts-btn').addEventListener('click', function() { loadReceipts(); });

    document.getElementById('inventoryList').addEventListener('click', function(e) {
      var btn = e.target.closest('.stock-btn');
      if (btn) {
        var index = parseInt(btn.getAttribute('data-stock-index'), 10);
        var delta = parseInt(btn.getAttribute('data-stock-delta'), 10);
        if (!isNaN(index) && !isNaN(delta)) adjustStock(index, delta);
      }
    });

    document.getElementById('kdsGrid').addEventListener('click', function(e) {
      var btn = e.target.closest('.kds-btn');
      if (btn) {
        var orderId = btn.getAttribute('data-order-id');
        var nextStatus = btn.getAttribute('data-next-status');
        if (orderId && nextStatus) updateKdsStatus(orderId, nextStatus);
      }
    });

    // ‚îÄ‚îÄ‚îÄ Tab Switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.querySelector('.tab-bar').addEventListener('click', function(e) {
      var btn = e.target.closest('.tab-btn');
      if (!btn) return;
      var tab = btn.getAttribute('data-tab');
      document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); b.setAttribute('aria-selected', 'false'); });
      document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
      var panel = document.getElementById('tab-' + tab);
      if (panel) panel.classList.add('active');
      // Lazy-load tab data on first visit
      if (tab === 'catalog' && !catalogLoaded) loadCatalog();
      if (tab === 'hiring' && !hiringLoaded) loadHiring();
    });

    // ‚îÄ‚îÄ‚îÄ CATALOG TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var catalogLoaded = false;
    var catalogItems = [];

    async function loadCatalog() {
      try {
        var client = window.brewAuth.client;
        if (!client) return;
        var { data, error } = await client
          .from('merch_products')
          .select('*')
          .order('created_at', { ascending: false });
        if (error) throw error;
        catalogItems = data || [];
        catalogLoaded = true;
        renderCatalog();
      } catch (err) {
        console.error('Catalog fetch failed:', err);
        document.getElementById('catalog-grid').innerHTML = '<div style="padding:1rem;color:#e74c3c;">Failed to load catalog</div>';
      }
    }

    function renderCatalog() {
      var grid = document.getElementById('catalog-grid');
      if (catalogItems.length === 0) {
        grid.innerHTML = '<div style="padding:2rem;color:#666;text-align:center;">No products yet. Add one above!</div>';
        return;
      }
      grid.innerHTML = catalogItems.map(function(p) {
        var price = (parseInt(p.price_cents) || 0) / 100;
        var cat = (p.category || 'menu').toUpperCase();
        var active = p.is_active !== false;
        var imgHtml = p.image_url
          ? '<img class="cat-img-thumb" src="' + escapeHtml(p.image_url) + '" alt="' + escapeHtml(p.name) + '" onerror="this.outerHTML=\'<div class=cat-img-placeholder>‚òï</div>\'" />'
          : '<div class="cat-img-placeholder">‚òï</div>';
        return '<div class="catalog-card' + (active ? '' : '" style="opacity:0.5') + '">' +
          imgHtml +
          '<div class="cat-badge">' + escapeHtml(cat) + '</div>' +
          (active ? '' : '<div style="background:#7f1d1d;color:#fecaca;font-size:0.75rem;padding:4px 10px;border-radius:6px;margin-bottom:4px;display:inline-block;font-weight:700;letter-spacing:0.05em;">ARCHIVED</div>') +
          '<div class="cat-name">' + escapeHtml(p.name) + '</div>' +
          (p.description ? '<div style="font-size:0.8rem;color:#888;margin-bottom:0.5rem;">' + escapeHtml(p.description) + '</div>' : '') +
          '<div class="cat-price">$' + price.toFixed(2) + '</div>' +
          '<div class="catalog-actions">' +
            '<button data-catalog-edit="' + escapeHtml(p.id) + '" aria-label="Edit ' + escapeHtml(p.name) + '">‚úèÔ∏è Edit</button>' +
            '<button data-catalog-toggle="' + escapeHtml(p.id) + '" data-active="' + active + '" aria-label="' + (active ? 'Hide' : 'Show') + ' ' + escapeHtml(p.name) + '">' + (active ? 'üëÅ Hide' : 'üëÅ Show') + '</button>' +
            (active ? '<button class="cat-delete" data-catalog-delete="' + escapeHtml(p.id) + '" aria-label="Archive ' + escapeHtml(p.name) + '">üóë Archive</button>' : '') +
          '</div>' +
        '</div>';
      }).join('');
    }

    // ‚îÄ‚îÄ‚îÄ IMAGE UPLOAD HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var IMAGE_TYPES = ['image/png','image/jpeg','image/webp','image/gif'];
    var MAX_IMG_SIZE = 5 * 1024 * 1024; // 5 MB

    function setupDropZone(zoneId, previewId, promptId, uploadingId, errorId, hiddenInputId, fileInputId) {
      var zone = document.getElementById(zoneId);
      var preview = document.getElementById(previewId);
      var prompt = document.getElementById(promptId);
      var uploading = document.getElementById(uploadingId);
      var errorEl = document.getElementById(errorId);
      var hidden = document.getElementById(hiddenInputId);
      var fileInput = document.getElementById(fileInputId);
      var busy = false;

      zone.addEventListener('click', function() { if (!busy) fileInput.click(); });
      zone.addEventListener('dragover', function(e) { e.preventDefault(); zone.classList.add('drag-over'); });
      zone.addEventListener('dragleave', function() { zone.classList.remove('drag-over'); });
      zone.addEventListener('drop', function(e) {
        e.preventDefault();
        zone.classList.remove('drag-over');
        var file = e.dataTransfer.files[0];
        if (file) handleImageFile(file);
      });
      fileInput.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (file) handleImageFile(file);
        fileInput.value = '';
      });

      async function handleImageFile(file) {
        if (busy) return;
        errorEl.textContent = '';
        if (IMAGE_TYPES.indexOf(file.type) === -1) {
          errorEl.textContent = '‚ö†Ô∏è Only PNG, JPG, WebP, or GIF photos are allowed.';
          return;
        }
        if (file.size > MAX_IMG_SIZE) {
          errorEl.textContent = '‚ö†Ô∏è Photo must be under 5 MB.';
          return;
        }
        busy = true;
        prompt.style.display = 'none';
        preview.style.display = 'none';
        uploading.style.display = '';
        try {
          var client = window.brewAuth.client;
          var ext = file.name.split('.').pop() || 'png';
          var safeName = (Date.now() + '_' + file.name.replace(/\.[^.]+$/, '')).replace(/[^a-zA-Z0-9_-]/g, '_');
          var path = 'catalog/' + safeName + '.' + ext;
          var result = await client.storage.from('menu-images').upload(path, file, { cacheControl: '3600', upsert: false });
          if (result.error) throw result.error;
          var urlData = client.storage.from('menu-images').getPublicUrl(path);
          var publicUrl = urlData.data.publicUrl;
          hidden.value = publicUrl;
          preview.src = publicUrl;
          preview.style.display = '';
          prompt.style.display = 'none';
        } catch (err) {
          errorEl.textContent = '‚ö†Ô∏è Upload failed: ' + (err.message || 'unknown error');
          prompt.style.display = '';
        } finally {
          uploading.style.display = 'none';
          busy = false;
        }
      }

      return { reset: function() {
        hidden.value = '';
        preview.src = '';
        preview.style.display = 'none';
        prompt.style.display = '';
        uploading.style.display = 'none';
        errorEl.textContent = '';
      }};
    }

    var addDropZone = setupDropZone('add-image-drop', 'add-image-preview', 'add-drop-prompt', 'add-drop-uploading', 'add-drop-error', 'add-image-url', 'add-image-file');

    // ‚îÄ‚îÄ‚îÄ ADD NEW PRODUCT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('catalog-add-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      try {
        var client = window.brewAuth.client;
        var fd = new FormData(e.target);
        var dollars = parseFloat(fd.get('price_dollars')) || 0;
        var cents = Math.round(dollars * 100);
        var { error } = await client.from('merch_products').insert({
          name: fd.get('name'),
          price_cents: cents,
          description: fd.get('description') || null,
          category: fd.get('category') || 'menu',
          image_url: fd.get('image_url') || null,
          is_active: fd.get('active') === 'true'
        });
        if (error) throw error;
        e.target.reset();
        addDropZone.reset();
        loadCatalog();
      } catch (err) {
        alert('Failed to add item: ' + err.message);
      }
    });

    // ‚îÄ‚îÄ‚îÄ TOGGLE / DELETE / EDIT CATALOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('catalog-grid').addEventListener('click', async function(e) {
      var toggleBtn = e.target.closest('[data-catalog-toggle]');
      var deleteBtn = e.target.closest('[data-catalog-delete]');
      var editBtn = e.target.closest('[data-catalog-edit]');
      var client = window.brewAuth.client;
      if (toggleBtn) {
        var id = toggleBtn.getAttribute('data-catalog-toggle');
        var isActive = toggleBtn.getAttribute('data-active') === 'true';
        await client.from('merch_products').update({ is_active: !isActive }).eq('id', id);
        loadCatalog();
      }
      if (deleteBtn) {
        var did = deleteBtn.getAttribute('data-catalog-delete');
        if (confirm('Archive this product? It will be hidden from the public shop but preserved for order history.')) {
          await client.from('merch_products').update({ is_active: false }).eq('id', did);
          loadCatalog();
        }
      }
      if (editBtn) {
        var eid = editBtn.getAttribute('data-catalog-edit');
        openEditModal(eid);
      }
    });

    document.getElementById('refresh-catalog-btn').addEventListener('click', function() { loadCatalog(); });

    // ‚îÄ‚îÄ‚îÄ INLINE EDIT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openEditModal(productId) {
      var p = catalogItems.find(function(i) { return i.id === productId; });
      if (!p) return;
      var price = (parseInt(p.price_cents) || 0) / 100;

      // Store element that opened the modal so we can restore focus on close
      var previouslyFocused = document.activeElement;

      var overlay = document.createElement('div');
      overlay.className = 'edit-overlay';
      overlay.setAttribute('role', 'dialog');
      overlay.setAttribute('aria-modal', 'true');
      overlay.setAttribute('aria-label', 'Edit product: ' + (p.name || 'Item'));
      overlay.innerHTML =
        '<div class="edit-modal">' +
          '<h3>‚úèÔ∏è Edit Item</h3>' +
          '<div class="edit-field"><label>Name</label><input id="edit-name" value="' + escapeHtml(p.name || '') + '" /></div>' +
          '<div class="edit-field"><label>Price ($)</label><input id="edit-price" type="number" step="0.01" min="0" value="' + price.toFixed(2) + '" /></div>' +
          '<div class="edit-field"><label>Description</label><input id="edit-desc" value="' + escapeHtml(p.description || '') + '" /></div>' +
          '<div class="edit-field"><label>Category</label><select id="edit-cat"><option value="menu"' + (p.category === 'menu' ? ' selected' : '') + '>‚òï Cafe Menu</option><option value="merch"' + (p.category === 'merch' ? ' selected' : '') + '>üõçÔ∏è Merch & Beans</option></select></div>' +
          '<div class="edit-field"><label>Photo</label>' +
            '<div class="image-drop-zone" id="edit-image-drop" style="min-height:100px;">' +
              '<img id="edit-image-preview" class="drop-preview-img" ' + (p.image_url ? 'src="' + escapeHtml(p.image_url) + '"' : 'style="display:none;"') + ' alt="Preview" />' +
              '<div class="drop-prompt" id="edit-drop-prompt"' + (p.image_url ? ' style="display:none;"' : '') + '><span style="font-size:1.5rem;">üì∏</span><span style="font-size:0.8rem;color:#888;">Drop new photo or click to browse</span></div>' +
              '<div class="drop-uploading" id="edit-drop-uploading" style="display:none;"><span class="pulse-text">Uploading‚Ä¶</span></div>' +
              '<input type="file" id="edit-image-file" accept="image/png,image/jpeg,image/webp,image/gif" style="display:none;" />' +
              '<input type="hidden" id="edit-image-url" value="' + escapeHtml(p.image_url || '') + '" />' +
              '<div class="drop-error" id="edit-drop-error"></div>' +
            '</div>' +
          '</div>' +
          '<div class="edit-btns">' +
            '<button class="cancel-btn" id="edit-cancel">Cancel</button>' +
            '<button class="save-btn" id="edit-save">üíæ Save Changes</button>' +
          '</div>' +
        '</div>';

      document.body.appendChild(overlay);

      // Wire the drop zone inside the modal
      var editDZ = setupDropZone('edit-image-drop', 'edit-image-preview', 'edit-drop-prompt', 'edit-drop-uploading', 'edit-drop-error', 'edit-image-url', 'edit-image-file');

      // ‚îÄ‚îÄ Focus Trap: move focus into modal and trap Tab key ‚îÄ‚îÄ
      var firstInput = overlay.querySelector('#edit-name');
      if (firstInput) firstInput.focus();

      function trapFocus(e) {
        if (e.key === 'Tab') {
          var focusable = overlay.querySelectorAll('input, select, button, [tabindex]:not([tabindex="-1"])');
          if (focusable.length === 0) return;
          var first = focusable[0];
          var last = focusable[focusable.length - 1];
          if (e.shiftKey) {
            if (document.activeElement === first) { e.preventDefault(); last.focus(); }
          } else {
            if (document.activeElement === last) { e.preventDefault(); first.focus(); }
          }
        }
        if (e.key === 'Escape') { closeModal(); }
      }
      document.addEventListener('keydown', trapFocus);

      function closeModal() {
        document.removeEventListener('keydown', trapFocus);
        overlay.remove();
        if (previouslyFocused) previouslyFocused.focus();
      }

      overlay.addEventListener('click', function(evt) {
        if (evt.target === overlay) closeModal();
      });
      document.getElementById('edit-cancel').addEventListener('click', function() { closeModal(); });
      document.getElementById('edit-save').addEventListener('click', async function() {
        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Saving‚Ä¶';
        try {
          var client = window.brewAuth.client;
          var newDollars = parseFloat(document.getElementById('edit-price').value) || 0;
          var newCents = Math.round(newDollars * 100);
          var { error } = await client.from('merch_products').update({
            name: document.getElementById('edit-name').value,
            price_cents: newCents,
            description: document.getElementById('edit-desc').value || null,
            category: document.getElementById('edit-cat').value,
            image_url: document.getElementById('edit-image-url').value || null
          }).eq('id', productId);
          if (error) throw error;
          closeModal();
          loadCatalog();
        } catch (err) {
          alert('Save failed: ' + err.message);
          btn.disabled = false;
          btn.textContent = 'üíæ Save Changes';
        }
      });
    }

    // ‚îÄ‚îÄ‚îÄ HIRING TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var hiringLoaded = false;
    var allApplicants = [];
    var hiringFilter = 'all';
    var expandedApplicant = null;
    var HIRING_STATUSES = ['pending', 'reviewed', 'interview', 'hired', 'rejected'];

    async function loadHiring() {
      try {
        var client = window.brewAuth.client;
        if (!client) return;
        var { data, error } = await client
          .from('job_applications')
          .select('*')
          .order('created_at', { ascending: false });
        if (error) throw error;
        allApplicants = data || [];
        hiringLoaded = true;
        renderHiringFilters();
        renderApplicants();
      } catch (err) {
        console.error('Hiring fetch failed:', err);
        document.getElementById('applicants-list').innerHTML = '<div style="padding:1rem;color:#e74c3c;">Failed to load applications</div>';
      }
    }

    function renderHiringFilters() {
      var counts = { all: allApplicants.length };
      HIRING_STATUSES.forEach(function(s) { counts[s] = allApplicants.filter(function(a) { return a.status === s; }).length; });
      var container = document.getElementById('hiring-filters');
      container.innerHTML = ['all'].concat(HIRING_STATUSES).map(function(s) {
        return '<button class="hiring-pill' + (hiringFilter === s ? ' active' : '') + '" data-hiring-filter="' + s + '">' + s + ' (' + (counts[s] || 0) + ')</button>';
      }).join('');
    }

    function renderApplicants() {
      var list = hiringFilter === 'all' ? allApplicants : allApplicants.filter(function(a) { return a.status === hiringFilter; });
      var container = document.getElementById('applicants-list');
      if (list.length === 0) {
        container.innerHTML = '<div style="padding:2rem;text-align:center;color:#666;">No applications found.</div>';
        return;
      }
      container.innerHTML = list.map(function(a) {
        var initials = a.name.split(' ').map(function(w) { return w[0]; }).join('').slice(0,2).toUpperCase();
        var dateStr = new Date(a.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        var isOpen = expandedApplicant === a.id;
        return '<div class="applicant-card">' +
          '<div class="applicant-row" data-applicant-toggle="' + escapeHtml(a.id) + '">' +
            '<div style="display:flex;align-items:center;gap:0.75rem;min-width:0;">' +
              '<div class="applicant-avatar">' + escapeHtml(initials) + '</div>' +
              '<div style="min-width:0;"><div class="applicant-name">' + escapeHtml(a.name) + '</div><div class="applicant-email">' + escapeHtml(a.email) + (a.phone ? ' ¬∑ ' + escapeHtml(a.phone) : '') + '</div></div>' +
            '</div>' +
            '<div class="applicant-meta">' +
              (a.resume_url ? '<a href="' + escapeHtml(a.resume_url) + '" target="_blank" rel="noopener" class="resume-link" onclick="event.stopPropagation()">üìÑ PDF</a>' : '') +
              '<span class="app-status ' + escapeHtml(a.status) + '">' + escapeHtml(a.status) + '</span>' +
              '<span style="font-size:0.75rem;color:#666;">' + escapeHtml(dateStr) + '</span>' +
              '<span style="color:#555;">' + (isOpen ? '‚ñ≤' : '‚ñº') + '</span>' +
            '</div>' +
          '</div>' +
          '<div class="applicant-detail' + (isOpen ? ' open' : '') + '" id="detail-' + escapeHtml(a.id) + '">' +
            '<div class="detail-grid">' +
              '<div><div class="detail-label">‚è∞ Availability</div><div class="detail-value">' + escapeHtml(a.availability || 'Not specified') + '</div></div>' +
              '<div><div class="detail-label">üí¨ Scenario Answer</div><div class="detail-value" style="font-style:italic;">"' + escapeHtml(a.scenario_answer) + '"</div></div>' +
            '</div>' +
            '<div class="status-btns">' +
              '<span style="font-size:0.7rem;color:#666;align-self:center;margin-right:0.25rem;">Move to:</span>' +
              HIRING_STATUSES.filter(function(s) { return s !== a.status; }).map(function(s) {
                return '<button data-status-update="' + escapeHtml(a.id) + '" data-new-status="' + s + '">' + s + '</button>';
              }).join('') +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    // Hiring event delegation
    document.getElementById('hiring-filters').addEventListener('click', function(e) {
      var pill = e.target.closest('.hiring-pill');
      if (!pill) return;
      hiringFilter = pill.getAttribute('data-hiring-filter');
      renderHiringFilters();
      renderApplicants();
    });

    document.getElementById('applicants-list').addEventListener('click', async function(e) {
      // Toggle expand
      var row = e.target.closest('[data-applicant-toggle]');
      if (row) {
        var id = row.getAttribute('data-applicant-toggle');
        expandedApplicant = (expandedApplicant === id) ? null : id;
        renderApplicants();
        return;
      }
      // Status update
      var statusBtn = e.target.closest('[data-status-update]');
      if (statusBtn) {
        var aid = statusBtn.getAttribute('data-status-update');
        var ns = statusBtn.getAttribute('data-new-status');
        try {
          var client = window.brewAuth.client;
          var { error } = await client.from('job_applications').update({ status: ns }).eq('id', aid);
          if (error) throw error;
          allApplicants = allApplicants.map(function(a) { return a.id === aid ? Object.assign({}, a, { status: ns }) : a; });
          renderHiringFilters();
          renderApplicants();
        } catch (err) {
          alert('Failed to update status: ' + err.message);
        }
      }
    });

    document.getElementById('refresh-hiring-btn').addEventListener('click', function() { loadHiring(); });

    init();
  </script>
</body>
</html>