<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>BrewHub Manager Dashboard</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script src="/js/auth.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #0f0f0f; min-height: 100vh; color: #f5f5f5; }
    .header { background: #1a1a1a; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
    .logo { font-size: 1.5rem; font-weight: 700; color: #f5f5f5; cursor: pointer; }
    .logo span { color: #f39c12; }
    .nav-links a { color: #ccc; text-decoration: none; margin-left: 2rem; font-size: 0.9rem; transition: color 0.2s; }
    .nav-links a:hover, .nav-links a.active { color: #f39c12; }
    .container { padding: 2rem; max-width: 1400px; margin: 0 auto; }
    
    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: #1a1a1a; border-radius: 16px; padding: 1.5rem; border: 1px solid #333; }
    .stat-label { font-size: 0.85rem; color: #888; margin-bottom: 0.5rem; }
    .stat-value { font-size: 2rem; font-weight: 700; color: #f5f5f5; }
    .stat-value.revenue { color: #27ae60; }
    .stat-value.orders { color: #3498db; }
    .stat-change { font-size: 0.8rem; color: #666; margin-top: 0.5rem; }
    
    /* Main Grid */
    .main-grid { display: grid; grid-template-columns: 1fr 400px; gap: 2rem; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .inventory-table { background: #1a1a1a; border-radius: 16px; overflow: hidden; border: 1px solid #333; }
    .inventory-header { display: grid; grid-template-columns: 2fr 1fr 1fr 120px; padding: 1rem 1.5rem; background: #222; font-size: 0.75rem; color: #888; }
    .inventory-row { display: grid; grid-template-columns: 2fr 1fr 1fr 120px; padding: 1rem 1.5rem; border-bottom: 1px solid #222; align-items: center; }
    .stock-btn { width: 32px; height: 32px; border-radius: 8px; border: none; background: #333; color: #fff; cursor: pointer; }
    .stock-btn:hover { background: #444; }
    
    .sidebar { display: flex; flex-direction: column; gap: 1.5rem; }
    .card { background: #1a1a1a; border-radius: 16px; padding: 1.5rem; border: 1px solid #333; }
    .activity-list { display: flex; flex-direction: column; gap: 0.75rem; }
    
    /* KDS Mini */
    .kds-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .kds-card { background: #1a1a1a; border-radius: 12px; border: 1px solid #333; overflow: hidden; }
    .kds-card.paid { border-top: 4px solid #27ae60; }
    .kds-card.preparing { border-top: 4px solid #f39c12; }
    .kds-card.ready { border-top: 4px solid #3498db; }
    .kds-header { padding: 0.75rem 1rem; background: #222; display: flex; justify-content: space-between; align-items: center; }
    .kds-items { padding: 0.75rem 1rem; font-size: 0.9rem; }
    .kds-item { padding: 0.25rem 0; border-bottom: 1px solid #2a2a2a; }
    .kds-item:last-child { border-bottom: none; }
    .kds-actions { padding: 0.75rem 1rem; background: #1a1a1a; display: flex; gap: 0.5rem; }
    .kds-btn { flex: 1; padding: 0.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.75rem; }
    .kds-btn.start { background: #27ae60; color: #fff; }
    .kds-btn.ready { background: #f39c12; color: #fff; }
    .kds-btn.done { background: #3498db; color: #fff; }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link" style="position:absolute;top:-40px;left:0;background:#000;color:#fff;padding:8px;z-index:100;transition:top 0.3s;" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Skip to main content</a>
  <header class="header">
    <div class="logo" onclick="window.location.href='/index.html'">Brew<span>Hub</span> Dashboard</div>
    <nav class="nav-links">
      <a href="kds.html">KDS</a>
      <a href="cafe.html">Cafe POS</a>
      <a href="parcels.html">Parcel Hub</a>
      <a href="scan.html">Inventory</a>
      <a href="manager.html" class="active">Dashboard</a>
      <a href="#" onclick="window.brewAuth.signOut()" style="color: #e74c3c;">Logout</a>
    </nav>
  </header>

  <main class="container">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Today's Revenue <button onclick="loadSalesReport()" style="background:none;border:none;cursor:pointer;font-size:0.8rem;">ðŸ”„</button></div>
        <div class="stat-value revenue" id="totalRevenue">$0.00</div>
        <div class="stat-change" id="revenueChange">Syncing...</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Orders Today</div>
        <div class="stat-value orders" id="totalOrders">0</div>
        <div class="stat-change" id="ordersChange">Live</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Staff Clocked In</div>
        <div class="stat-value" id="activeStaff">0</div>
        <div id="staffList" class="stat-change">No active shifts</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Est. Daily Labor</div>
        <div class="stat-value" id="dailyLabor">$0.00</div>
        <div class="stat-change">Total Shift Cost</div>
      </div>
    </div>

    <div class="main-grid">
      <section>
        <div class="section-header">
          <h2>ðŸ“¦ Inventory Status</h2>
          <button class="refresh-btn" style="color:#888; background:none; border:1px solid #333; padding:5px 10px; cursor:pointer;" onclick="renderInventory()">â†» Refresh</button>
        </div>
        <div class="inventory-table">
          <div class="inventory-header">
            <span>Item</span>
            <span>Current Stock</span>
            <span>Threshold</span>
            <span>Adjust</span>
          </div>
          <div id="inventoryList"></div>
        </div>
      </section>

      <aside class="sidebar">
        <div class="card">
          <h3>âš¡ Recent Activity</h3>
          <div class="activity-list" id="activityList">
              <div style="font-size:0.8rem; color:#666;">Waiting for events...</div>
          </div>
        </div>
      </aside>
    </div>

    <!-- KDS Section -->
    <section style="margin-top: 2rem;">
      <div class="section-header">
        <h2>â˜• Active Orders (KDS)</h2>
        <button style="color:#888; background:none; border:1px solid #333; padding:5px 10px; cursor:pointer;" onclick="loadKdsOrders()">â†» Refresh</button>
      </div>
      <div class="kds-grid" id="kdsGrid">
        <div style="padding: 1rem; color: #666;">Loading orders...</div>
      </div>
    </section>

    <!-- Payroll Section -->
    <section style="margin-top: 2rem;">
      <div class="section-header">
        <h2>ðŸ’° Payroll Tally</h2>
        <span id="grand-total" style="color: #27ae60; font-size: 1.5rem; font-weight: 700;">$0.00</span>
      </div>
      <div class="inventory-table">
        <div class="inventory-header" style="grid-template-columns: 2fr 1fr 1fr 1fr 100px;">
          <span>Staff</span>
          <span>Rate</span>
          <span>Hours</span>
          <span>Earned</span>
          <span>Status</span>
        </div>
        <div id="payroll-list">
          <div style="padding: 1rem 1.5rem; color: #666;">Loading payroll...</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Static inventory data (Placeholder for now)
    const inventory = [
      { name: 'Espresso Beans', category: 'Coffee', current: 3, threshold: 10, unit: 'lbs' },
      { name: 'Oat Milk', category: 'Dairy Alt', current: 2, threshold: 8, unit: 'gal' },
      { name: 'Vanilla Syrup', category: 'Syrups', current: 4, threshold: 4, unit: 'bottles' }
    ];

    function renderInventory() {
      const container = document.getElementById('inventoryList');
      container.innerHTML = inventory.map((item, i) => `
        <div class="inventory-row">
          <div><div class="item-name">${item.name}</div><div class="item-category">${item.category}</div></div>
          <div class="stock-level">${item.current} ${item.unit}</div>
          <div class="threshold">${item.threshold} ${item.unit}</div>
          <div class="stock-controls">
            <button class="stock-btn" onclick="adjustStock(${i}, -1)">âˆ’</button>
            <button class="stock-btn" onclick="adjustStock(${i}, 1)">+</button>
          </div>
        </div>
      `).join('');
    }

    function adjustStock(index, delta) {
      inventory[index].current = Math.max(0, inventory[index].current + delta);
      renderInventory();
    }

    // --- KDS Functions ---
    let kdsOrders = [];
    
    async function loadKdsOrders() {
      try {
        const client = window.brewAuth.client;
        if (!client) return;
        
        const { data, error } = await client
          .from('orders')
          .select('*, coffee_orders(*)')
          .in('status', ['paid', 'preparing', 'ready'])
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        kdsOrders = data || [];
        renderKds();
      } catch (err) {
        console.error('KDS fetch failed:', err);
        document.getElementById('kdsGrid').innerHTML = '<div style="padding:1rem;color:#e74c3c;">Failed to load orders</div>';
      }
    }
    
    function renderKds() {
      const grid = document.getElementById('kdsGrid');
      if (kdsOrders.length === 0) {
        grid.innerHTML = '<div style="padding:1rem;color:#666;">No active orders âœ“</div>';
        return;
      }
      
      grid.innerHTML = kdsOrders.map(order => {
        const items = order.coffee_orders || [];
        const timeAgo = Math.floor((Date.now() - new Date(order.created_at)) / 60000);
        const btnClass = order.status === 'paid' ? 'start' : order.status === 'preparing' ? 'ready' : 'done';
        const btnText = order.status === 'paid' ? 'â–¶ Start' : order.status === 'preparing' ? 'ðŸ”” Ready' : 'âœ“ Done';
        const nextStatus = order.status === 'paid' ? 'preparing' : order.status === 'preparing' ? 'ready' : 'completed';
        
        return `
          <div class="kds-card ${order.status}">
            <div class="kds-header">
              <strong>${order.customer_name || 'Guest'}</strong>
              <span style="font-size:0.75rem;color:#888;">${timeAgo}m ago</span>
            </div>
            <div class="kds-items">
              ${items.map(i => `<div class="kds-item">â˜• ${i.drink_name}</div>`).join('') || '<div class="kds-item" style="color:#666;">No items</div>'}
            </div>
            <div class="kds-actions">
              <button class="kds-btn ${btnClass}" onclick="updateKdsStatus('${order.id}', '${nextStatus}')">${btnText}</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    async function updateKdsStatus(orderId, newStatus) {
      try {
        const session = window.brewAuth.session;
        const res = await fetch('/.netlify/functions/update-order-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`
          },
          body: JSON.stringify({ orderId, status: newStatus })
        });
        
        if (!res.ok) throw new Error('Update failed');
        
        // Refresh KDS
        loadKdsOrders();
        loadSalesReport();
      } catch (err) {
        console.error('KDS update error:', err);
        alert('Failed to update order');
      }
    }

    // --- CRITICAL FIX: Auth Headers added here ---
    async function loadSalesReport() {
      try {
        const session = window.brewAuth.session;
        if (!session) return; // Wait for login

        const res = await fetch('/.netlify/functions/sales-report', {
            headers: {
                'Authorization': `Bearer ${session.access_token}`
            }
        });

        if (res.status === 401) {
            console.error("Token Expired or Invalid");
            return;
        }

        if (!res.ok) throw new Error('API Error');
        
        const data = await res.json();
        
        // Matches SQL: COALESCE(SUM(total_amount_cents), 0) / 100.0 as gross_revenue
        document.getElementById('totalRevenue').textContent = '$' + parseFloat(data.gross_revenue || 0).toFixed(2);
        document.getElementById('totalOrders').textContent = data.total_orders || 0;
        document.getElementById('revenueChange').textContent = 'â†‘ Live Sync';
      } catch (err) {
        console.warn('Sales report fetch failed:', err);
        document.getElementById('totalRevenue').textContent = '$0.00';
      }
    }

    async function loadStaffStatus() {
        try {
            const client = window.brewAuth.client;
            if (!client) return;

            const { data, error } = await client
                .from('staff_directory')
                .select('*');

            if (error) throw error;
            
            // Filter locally to avoid complex DB joins for now
            const workingStaff = data.filter(s => s.is_working === true);
            
            document.getElementById('activeStaff').textContent = workingStaff.length;
            document.getElementById('staffList').textContent = workingStaff.map(s => s.name).join(', ') || 'No one active';
            
            // Calculate labor based on 'hourly_rate'
            const activeLabor = workingStaff.reduce((acc, curr) => acc + (parseFloat(curr.hourly_rate) || 0), 0);
            document.getElementById('dailyLabor').textContent = '$' + activeLabor.toFixed(2);
        } catch (e) {
            console.error("Staff fetch failed", e);
            document.getElementById('staffList').textContent = "Connection issue";
        }
    }

    async function loadPayroll() {
        try {
            const client = window.brewAuth.client;
            if (!client) return;

            const list = document.getElementById('payroll-list');
            let grandTotal = 0;

            const [pRes, lRes] = await Promise.all([
                client.from('staff_directory').select('*'),
                client.from('time_logs').select('*').order('created_at', { ascending: true })
            ]);

            if (pRes.error) throw pRes.error;
            if (lRes.error) throw lRes.error;

            const employees = pRes.data || [];
            const logs = lRes.data || [];

            if (employees.length === 0) {
                list.innerHTML = '<div style="padding: 1rem 1.5rem; color: #666;">No staff found</div>';
                return;
            }

            list.innerHTML = '';

            employees.forEach(emp => {
                let totalHours = 0;
                const empLogs = logs.filter(l => l.employee_email === emp.email);
                
                // Pair INs with OUTs
                let startTime = null;
                empLogs.forEach(log => {
                    const type = (log.action_type || '').toLowerCase();
                    if (type === 'in') {
                        startTime = new Date(log.clock_in || log.created_at);
                    } else if (type === 'out' && startTime) {
                        const endTime = new Date(log.clock_out || log.created_at);
                        totalHours += (endTime - startTime) / 3600000;
                        startTime = null;
                    }
                });

                const rate = parseFloat(emp.hourly_rate) || 0;
                const earned = totalHours * rate;
                grandTotal += earned;

                const lastLog = empLogs[empLogs.length - 1];
                const status = (lastLog?.action_type || 'OFF').toUpperCase();
                const statusColor = status === 'IN' ? '#27ae60' : '#e74c3c';

                list.innerHTML += `
                    <div class="inventory-row" style="grid-template-columns: 2fr 1fr 1fr 1fr 100px;">
                        <div><strong>${emp.name || 'Staff'}</strong><div style="font-size:0.75rem;color:#666;">${emp.email}</div></div>
                        <div>$${rate.toFixed(2)}/hr</div>
                        <div>${totalHours.toFixed(2)} hrs</div>
                        <div style="color: #27ae60; font-weight: 600;">$${earned.toFixed(2)}</div>
                        <div><span style="background:${statusColor}; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:bold; color:white;">${status}</span></div>
                    </div>
                `;
            });

            document.getElementById('grand-total').textContent = `$${grandTotal.toFixed(2)}`;

        } catch (e) {
            console.error("Payroll fetch failed", e);
            document.getElementById('payroll-list').innerHTML = '<div style="padding: 1rem 1.5rem; color: #e74c3c;">Failed to load payroll</div>';
        }
    }

    async function init() {
      // 1. Wait safely for auth system to load
      let attempts = 0;
      while (!window.brewAuth && attempts < 50) {
        await new Promise(r => setTimeout(r, 100));
        attempts++;
      }

      if (!window.brewAuth) {
          console.error("CRITICAL: /js/auth.js failed to load.");
          return;
      }

      // 2. Protect Page - Require staff role (for clock in/out)
      const user = await window.brewAuth.protectPage({ requiredRole: 'staff' });
      if (!user) return;

      console.log("Manager Logged In:", user.email, "Role:", window.brewAuth.staff?.role);

      // Conditionally show manager features
      if (user.role !== 'manager' && user.role !== 'admin') {
        // Staff: Hide inventory section and link
        const inventorySection = document.querySelector('.main-grid section');
        if (inventorySection) inventorySection.style.display = 'none';
        const inventoryLink = document.querySelector('a[href="scan.html"]');
        if (inventoryLink) inventoryLink.style.display = 'none';
      }

      // 3. Populate Dashboard
      renderInventory();
      loadSalesReport();
      loadStaffStatus();
      loadPayroll();

      // 4. Real-time subscription - refresh sales when orders change
      const client = window.brewAuth.client;
      client.channel('manager-orders')
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders' }, (payload) => {
          // Refresh sales report when any order status changes (especially to 'completed')
          console.log('Order updated:', payload.new?.status);
          loadSalesReport();
        })
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, () => {
          console.log('New order received');
          loadSalesReport();
        })
        .subscribe((status) => {
          console.log('[REALTIME] Subscription status:', status);
        });
    }

    init();
  </script>
</body>
</html>