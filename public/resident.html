<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrewHub Resident Registration</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/brand-system.css">
    <style>
        body { font-family: var(--font-body); background: var(--bg-main); color: var(--brand-primary); max-width: 600px; margin: 0 auto; padding: 20px; }
        h1, h2, h3 { font-family: var(--font-heading); color: var(--brand-primary); }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border-soft); }
        button, .btn { background: var(--brand-accent); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; }
        button:hover, .btn:hover { opacity: 0.9; }
        button:disabled, .btn:disabled { background: #999; cursor: not-allowed; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-soft); border-radius: 8px; box-sizing: border-box; background: white; color: var(--brand-primary); }
        .hidden { display: none; }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <main id="main-content">
        <div class="card" role="form" aria-labelledby="register-heading">
            <h1 id="register-heading">Register for package tracking &amp; coffee rewards.</h1>
            <label for="reg-name" class="visually-hidden">Full Name (required)</label>
            <input type="text" id="reg-name" placeholder="Full Name *" required aria-required="true" />
            <label for="reg-address" class="visually-hidden">Unit number or Address (required)</label>
            <input type="text" id="reg-address" placeholder="Unit # or Address *" required aria-required="true" />
            <label for="reg-email" class="visually-hidden">Email address (required)</label>
            <input type="email" id="reg-email" placeholder="Email *" required autocomplete="email" aria-required="true" />
            <label for="reg-password" class="visually-hidden">Password, minimum 6 characters (required)</label>
            <input type="password" id="reg-password" placeholder="Password (min 6 characters) *" required autocomplete="new-password" aria-required="true" />
            <label for="reg-password-confirm" class="visually-hidden">Confirm Password (required)</label>
            <input type="password" id="reg-password-confirm" placeholder="Confirm Password *" required autocomplete="new-password" aria-required="true" />
            <label for="reg-phone" class="visually-hidden">Phone number for text alerts (optional)</label>
            <input type="tel" id="reg-phone" placeholder="Phone (optional - for text alerts)" />
            <div style="margin-bottom: 10px; display: flex; align-items: flex-start; gap: 10px;">
                <input type="checkbox" id="sms-consent" name="sms_consent" required style="margin-top: 5px;">
                <label for="sms-consent" style="font-size: 14px; line-height: 1.4; color: #333;">
                    I agree to receive SMS notifications about my packages from BrewHub PHL.
                    Message frequency varies. Msg &amp; data rates may apply.
                    Reply STOP to unsubscribe.
                </label>
            </div>

            <p style="font-size: 12px; color: #666; margin-bottom: 20px;">
                By registering, you agree to our
                <a href="/terms.html" target="_blank" style="text-decoration: underline;">Terms &amp; Conditions</a>
                and
                <a href="/privacy.html" target="_blank" style="text-decoration: underline;">Privacy Policy</a>.
            </p>
            <button id="register-btn" onclick="handleRegister()">Register</button>
            <p id="register-msg" style="margin-top: 10px; font-size: 0.9rem; color: #666;" role="status" aria-live="polite"></p>
            <p style="margin-top:20px; text-align:center;">
                <a href="/portal.html" style="color:var(--dark); text-decoration:none;">Already have an account? <strong>Log in</strong></a>
            </p>
        </div>
    </main>

    <script>
        // 1. SETUP SUPABASE
        const SUPABASE_URL = 'https://rruionkpgswvncypweiv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydWlvbmtwZ3N3dm5jeXB3ZWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzMTQ5MDYsImV4cCI6MjA4NDg5MDkwNn0.fzM310q9Qs_f-zhuBqyjnQXs3mDmOp_dbiFRs0ctQmU';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Redirect logged-in residents back to portal
        (async () => {
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                window.location.href = '/portal.html';
            }
        })();

        // REGISTER LOGIC (email + password)
        async function handleRegister() {
            const name = document.getElementById('reg-name').value.trim();
            const address = document.getElementById('reg-address').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-password-confirm').value;
            const phone = document.getElementById('reg-phone').value.trim() || null;
            const smsOptIn = document.getElementById('sms-consent').checked;
            const msg = document.getElementById('register-msg');
            const btn = document.getElementById('register-btn');

            if (!name || !address || !email || !password) {
                msg.innerText = "Please fill in all required fields.";
                return;
            }

            if (password.length < 6) {
                msg.innerText = "Password must be at least 6 characters.";
                return;
            }

            if (password !== confirmPassword) {
                msg.innerText = "Passwords don't match.";
                return;
            }

            msg.innerText = "Registering...";
            btn.disabled = true;

            // Create auth user with password
            console.log('[SIGNUP] Attempting signUp for:', email);
            const { data, error: authError } = await sb.auth.signUp({
                email,
                password
            });

            console.log('[SIGNUP] Result:', { data, authError });

            if (authError) {
                btn.disabled = false;
                console.error('[SIGNUP] Auth error:', authError);
                msg.innerText = "Error: " + authError.message;
                return;
            }

            // No user created = something went wrong silently
            if (!data.user) {
                btn.disabled = false;
                msg.innerText = "Signup failed. Please try again.";
                return;
            }

            // Check if email confirmation is required (no session returned)
            const needsEmailConfirmation = !data.session;

            // If we have a session, create customer record now
            if (data.session?.access_token) {
                const createRes = await fetch('/.netlify/functions/create-customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${data.session.access_token}`
                    },
                    body: JSON.stringify({
                        email,
                        name,
                        address,
                        phone,
                        sms_opt_in: smsOptIn
                    })
                });

                const createResult = await createRes.json();

                if (!createRes.ok) {
                    btn.disabled = false;
                    console.error('DB error:', createResult);
                    // Don't scare user - account is created, just profile issue
                    if (needsEmailConfirmation) {
                        msg.innerHTML = `
                            <div style="background:#d4edda; padding:15px; border-radius:8px; text-align:center;">
                                <strong>ðŸ“§ Check your email!</strong><br><br>
                                We sent a confirmation link to <strong>${email}</strong><br><br>
                                Click the link, then come back here to log in.
                            </div>
                        `;
                    } else {
                        msg.innerText = "Account created! Please log in.";
                    }
                    return;
                }
            } else {
                // Store pending profile until the user confirms email and logs in
                localStorage.setItem('pending_customer_profile', JSON.stringify({
                    email,
                    name,
                    address,
                    phone,
                    sms_opt_in: smsOptIn
                }));
            }

            // If email confirmation required, show clear instructions
            if (needsEmailConfirmation) {
                btn.disabled = false;
                msg.innerHTML = `
                    <div style="background:#d4edda; padding:15px; border-radius:8px; text-align:center;">
                        <strong>ðŸ“§ Check your email!</strong><br><br>
                        We sent a confirmation link to <strong>${email}</strong><br><br>
                        Click the link, then come back here to log in.
                    </div>
                `;
                return;
            }

            // Redirect to portal after customer record is created
            btn.disabled = false;
            window.location.href = '/portal.html';
        }
    </script>
</body>
</html>
