<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | BrewHub PHL</title>
    <meta name="description" content="Complete your BrewHub merch order. Apple Pay, Google Pay, and credit cards accepted.">
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/brand-system.css">
    <!-- Square Web Payments SDK -->
    <script type="text/javascript" src="https://web.squarecdn.com/v1/square.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: var(--font-body, 'Work Sans', sans-serif);
            color: var(--brand-primary, #2d1f14);
            background: var(--bg-main, #faf7f2);
            min-height: 100vh;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid #eadfce;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(6px);
        }
        header .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            text-decoration: none;
            color: inherit;
        }
        header img { height: 36px; }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 32px 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
        }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            margin: 0 0 24px;
            color: var(--coffee, #4a3728);
        }
        h2 {
            font-size: 1.1rem;
            margin: 0 0 16px;
            color: var(--coffee, #4a3728);
        }
        .cart-summary {
            background: white;
            border-radius: 16px;
            border: 1px solid #efe1d2;
            padding: 24px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f5efe8;
        }
        .cart-item:last-of-type { border-bottom: none; }
        .cart-item-name { font-weight: 500; }
        .cart-item-qty { color: #7a6b60; font-size: 0.9rem; }
        .cart-item-price { font-weight: 600; }
        .cart-total {
            display: flex;
            justify-content: space-between;
            padding: 16px 0 0;
            margin-top: 16px;
            border-top: 2px solid #efe1d2;
            font-size: 1.2rem;
            font-weight: 700;
        }
        .payment-section {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-group label {
            font-weight: 500;
            font-size: 0.9rem;
            color: #5a4a42;
        }
        .form-group input {
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--coffee, #4a3728);
        }
        #apple-pay-button {
            display: none;
            -webkit-appearance: -apple-pay-button;
            appearance: auto;
            -apple-pay-button-type: buy;
            -apple-pay-button-style: black;
            width: 100%;
            height: 48px;
            border-radius: 8px;
            cursor: pointer;
        }
        #google-pay-button {
            display: none;
            width: 100%;
            height: 48px;
        }
        .divider {
            display: flex;
            align-items: center;
            gap: 16px;
            color: #999;
            font-size: 0.85rem;
            margin: 8px 0;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ddd;
        }
        #card-container {
            min-height: 90px;
        }
        .sq-card-iframe-container {
            border-radius: 8px !important;
        }
        .btn-pay {
            width: 100%;
            padding: 16px;
            background: var(--coffee, #4a3728);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-pay:hover { opacity: 0.9; }
        .btn-pay:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }
        .success-message {
            background: #efe;
            border: 1px solid #cfc;
            color: #060;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
        }
        .success-message h2 { color: #060; margin-bottom: 12px; }
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
        }
        .empty-cart a {
            display: inline-block;
            margin-top: 16px;
            padding: 12px 24px;
            background: var(--coffee, #4a3728);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        footer {
            text-align: center;
            padding: 40px;
            color: #6d5c52;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to checkout</a>

    <header>
        <a href="/shop.html" class="brand">
            <img src="logo.png" alt="BrewHub">
            <span>BrewHub PHL</span>
        </a>
    </header>

    <main id="main-content">
    <div class="container" id="checkout-container">
        <!-- Left: Cart Summary -->
        <div>
            <h1>Your Order</h1>
            <div class="cart-summary" id="cart-summary">
                <p>Loading cart...</p>
            </div>
            <p style="margin-top: 16px; font-size: 0.85rem; color: #7a6b60;">
                <a href="/shop.html" style="color: inherit;">‚Üê Continue shopping</a>
            </p>
        </div>

        <!-- Right: Payment -->
        <div class="payment-section" role="form" aria-labelledby="payment-heading">
            <h1 id="payment-heading">Payment</h1>
            
            <div id="error-message" class="error-message" role="alert" aria-live="assertive"></div>

            <!-- Customer Info -->
            <div class="form-group">
                <label for="email">Email (for receipt)</label>
                <input type="email" id="email" placeholder="you@example.com" required>
            </div>
            <div class="form-group">
                <label for="name">Name</label>
                <input type="text" id="name" placeholder="Your name" required>
            </div>

            <!-- Apple Pay Button -->
            <div id="apple-pay-button"></div>

            <!-- Google Pay Button -->
            <div id="google-pay-button"></div>

            <!-- Divider if wallet pay is available -->
            <div class="divider" id="wallet-divider" style="display: none;">or pay with card</div>

            <!-- Card Form -->
            <div id="card-container"></div>

            <!-- Pay Button -->
            <button class="btn-pay" id="pay-button" disabled>
                Pay Now
            </button>

            <p style="font-size: 0.8rem; color: #999; text-align: center; margin-top: 8px;">
                Secure payment powered by Square
            </p>
        </div>
    </div>

    <div id="success-container" style="display: none; max-width: 600px; margin: 60px auto; padding: 24px;" role="status" aria-live="polite">
        <div class="success-message">
            <h2>üéâ Order Confirmed!</h2>
            <p id="success-text">Thank you for your order.</p>
            <p style="margin-top: 16px;">
                <a href="/shop.html" style="color: var(--coffee, #4a3728); font-weight: 600;">Continue Shopping</a>
            </p>
        </div>
    </div>
    </main>

    <footer>
        BrewHub PHL ‚Ä¢ Point Breeze ‚Ä¢ Philly
    </footer>

    <script>
        // Square Application ID and Location (fetched from server)
        let SQUARE_APP_ID = null;
        let SQUARE_LOCATION_ID = null;

        let cart = [];
        let totalCents = 0;
        let payments = null;
        let card = null;
        let applePay = null;
        let googlePay = null;

        // Load cart from localStorage
        function loadCart() {
            try {
                cart = JSON.parse(localStorage.getItem('brewhub_cart') || '[]');
            } catch {
                cart = [];
            }
            return cart;
        }

        // Render cart summary
        function renderCart() {
            const container = document.getElementById('cart-summary');
            
            if (cart.length === 0) {
                document.getElementById('checkout-container').innerHTML = `
                    <div class="empty-cart" style="grid-column: 1 / -1;">
                        <h1 style="font-family: 'Playfair Display', serif;">Your cart is empty</h1>
                        <p>Add some BrewHub merch to get started.</p>
                        <a href="/shop.html">Shop Now</a>
                    </div>
                `;
                return false;
            }

            totalCents = 0;
            let html = '';

            for (const item of cart) {
                const itemTotal = item.price_cents * item.quantity;
                totalCents += itemTotal;
                html += `
                    <div class="cart-item">
                        <div>
                            <div class="cart-item-name">${escapeHtml(item.name)}</div>
                            <div class="cart-item-qty">Qty: ${item.quantity}</div>
                        </div>
                        <div class="cart-item-price">$${(itemTotal / 100).toFixed(2)}</div>
                    </div>
                `;
            }

            html += `
                <div class="cart-total">
                    <span>Total</span>
                    <span>$${(totalCents / 100).toFixed(2)}</span>
                </div>
            `;

            container.innerHTML = html;
            
            // Update pay button text
            document.getElementById('pay-button').textContent = `Pay $${(totalCents / 100).toFixed(2)}`;
            
            return true;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#39;');
        }

        function showError(message) {
            const el = document.getElementById('error-message');
            el.textContent = message;
            el.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        function showSuccess(orderId, receiptUrl) {
            document.getElementById('checkout-container').style.display = 'none';
            document.getElementById('success-container').style.display = 'block';
            
            const safeOrderId = escapeHtml(String(orderId));
            let text = `Order #${safeOrderId} confirmed. Check your email for receipt.`;
            if (receiptUrl) {
                // Validate URL is from Square domain before displaying
                try {
                    const url = new URL(receiptUrl);
                    if (url.hostname.endsWith('squareup.com') || url.hostname.endsWith('square.com')) {
                        text += ` <a href="${escapeHtml(receiptUrl)}" target="_blank" rel="noopener">View Receipt</a>`;
                    }
                } catch (e) {
                    // Invalid URL, skip the link
                }
            }
            document.getElementById('success-text').innerHTML = text;
            
            // Clear cart
            localStorage.removeItem('brewhub_cart');
        }

        async function initSquare() {
            if (!window.Square) {
                console.error('Square SDK failed to load');
                showError('Payment system unavailable. Please try again.');
                return;
            }

            try {
                payments = window.Square.payments(SQUARE_APP_ID, SQUARE_LOCATION_ID);

                // Initialize Card payment
                card = await payments.card();
                await card.attach('#card-container');

                // Enable pay button
                document.getElementById('pay-button').disabled = false;

                // Try Apple Pay
                try {
                    const applePayRequest = payments.paymentRequest({
                        countryCode: 'US',
                        currencyCode: 'USD',
                        total: {
                            amount: (totalCents / 100).toFixed(2),
                            label: 'BrewHub PHL',
                        },
                    });

                    applePay = await payments.applePay(applePayRequest);
                    document.getElementById('apple-pay-button').style.display = 'block';
                    document.getElementById('wallet-divider').style.display = 'flex';

                    document.getElementById('apple-pay-button').addEventListener('click', async () => {
                        await processWalletPayment(applePay, 'Apple Pay');
                    });
                } catch (e) {
                    console.log('Apple Pay not available:', e.message);
                }

                // Try Google Pay
                try {
                    const googlePayRequest = payments.paymentRequest({
                        countryCode: 'US',
                        currencyCode: 'USD',
                        total: {
                            amount: (totalCents / 100).toFixed(2),
                            label: 'BrewHub PHL',
                        },
                    });

                    googlePay = await payments.googlePay(googlePayRequest);
                    await googlePay.attach('#google-pay-button');
                    document.getElementById('google-pay-button').style.display = 'block';
                    document.getElementById('wallet-divider').style.display = 'flex';
                } catch (e) {
                    console.log('Google Pay not available:', e.message);
                }

            } catch (e) {
                console.error('Square init error:', e);
                showError('Failed to initialize payment. Please refresh the page.');
            }
        }

        async function processWalletPayment(walletMethod, walletName) {
            hideError();
            const payButton = document.getElementById('pay-button');
            payButton.disabled = true;
            payButton.innerHTML = '<span class="loading"><span class="spinner"></span> Processing...</span>';

            try {
                const result = await walletMethod.tokenize();
                
                if (result.status === 'OK') {
                    await submitPayment(result.token);
                } else {
                    showError(`${walletName} payment failed: ${result.errors?.[0]?.message || 'Unknown error'}`);
                    payButton.disabled = false;
                    payButton.textContent = `Pay $${(totalCents / 100).toFixed(2)}`;
                }
            } catch (e) {
                console.error('Wallet payment error:', e);
                showError(`${walletName} payment failed. Please try card payment.`);
                payButton.disabled = false;
                payButton.textContent = `Pay $${(totalCents / 100).toFixed(2)}`;
            }
        }

        async function processCardPayment() {
            hideError();
            const payButton = document.getElementById('pay-button');
            payButton.disabled = true;
            payButton.innerHTML = '<span class="loading"><span class="spinner"></span> Processing...</span>';

            try {
                const result = await card.tokenize();
                
                if (result.status === 'OK') {
                    await submitPayment(result.token);
                } else {
                    showError(result.errors?.[0]?.message || 'Card validation failed');
                    payButton.disabled = false;
                    payButton.textContent = `Pay $${(totalCents / 100).toFixed(2)}`;
                }
            } catch (e) {
                console.error('Card payment error:', e);
                showError('Card payment failed. Please check your details.');
                payButton.disabled = false;
                payButton.textContent = `Pay $${(totalCents / 100).toFixed(2)}`;
            }
        }

        async function submitPayment(sourceId) {
            const email = document.getElementById('email').value.trim();
            const name = document.getElementById('name').value.trim();

            if (!email) {
                showError('Please enter your email address.');
                document.getElementById('pay-button').disabled = false;
                document.getElementById('pay-button').textContent = `Pay $${(totalCents / 100).toFixed(2)}`;
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/process-merch-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cart,
                        sourceId,
                        customerEmail: email,
                        customerName: name,
                    }),
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccess(data.orderId, data.receiptUrl);
                } else {
                    showError(data.error || 'Payment failed. Please try again.');
                    document.getElementById('pay-button').disabled = false;
                    document.getElementById('pay-button').textContent = `Pay $${(totalCents / 100).toFixed(2)}`;
                }
            } catch (e) {
                console.error('Submit payment error:', e);
                showError('Connection error. Please try again.');
                document.getElementById('pay-button').disabled = false;
                document.getElementById('pay-button').textContent = `Pay $${(totalCents / 100).toFixed(2)}`;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch Square config
            try {
                const configRes = await fetch('/.netlify/functions/public-config');
                const config = await configRes.json();
                SQUARE_APP_ID = config.squareAppId;
                SQUARE_LOCATION_ID = config.squareLocationId;
            } catch (e) {
                console.error('Failed to load config:', e);
                showError('Payment system unavailable. Please try again later.');
                return;
            }

            if (!SQUARE_APP_ID || !SQUARE_LOCATION_ID) {
                showError('Payment configuration missing. Please contact support.');
                return;
            }

            loadCart();
            const hasItems = renderCart();
            
            if (hasItems) {
                await initSquare();
                
                // Card payment button
                document.getElementById('pay-button').addEventListener('click', processCardPayment);
            }
        });
    </script>
</body>
</html>
