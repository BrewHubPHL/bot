[build]
  publish = ".next"
  command = "npm run build"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[functions]
  directory = "netlify/functions"
  node_bundle = {}

[dev]
  command = "npm run dev"
  port = 8888
  targetPort = 3000
  framework = "next"

# ── Redirects ────────────────────────────────────────────────────

# Staff shortcut
[[redirects]]
  from = "/staff"
  to = "/login"
  status = 302
  force = true

# AI Agent API → Netlify Functions
[[redirects]]
  from = "/api/menu"
  to = "/.netlify/functions/get-menu"
  status = 200
  force = true

[[redirects]]
  from = "/api/order"
  to = "/.netlify/functions/ai-order"
  status = 200
  force = true

[[redirects]]
  from = "/api/loyalty"
  to = "/.netlify/functions/get-loyalty"
  status = 200
  force = true

[[redirects]]
  from = "/api/navigate"
  to = "/.netlify/functions/navigate-site"
  status = 200
  force = true

# ── Edge Functions ───────────────────────────────────────────────

[[edge_functions]]
  path = "/marketing-bot"
  function = "marketing-bot"

# ── Scheduled Functions ──────────────────────────────────────────

[functions."cancel-stale-orders"]
  schedule = "*/5 * * * *"

# ── Rate Limiting (Netlify Traffic Rules) ────────────────────────
# These are enforced at the edge CDN before functions spin up,
# preventing cold-start costs from botnet floods.
#
# Note: Netlify's built-in rate limiting requires a paid plan.
# At the function level, _token-bucket.js enforces per-IP burst limits.
# The headers below add CDN-level caching to reduce function invocations.